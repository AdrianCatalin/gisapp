/*
 *
 * eqwc.js -- build of Extended QGIS Web Client
 *
 * version: 1.7.1
 * buildDate: 2018-05-24
 *
 * Copyright (2010-2018), The QGIS Project and Level2 team All rights reserved.
 * More information at https://github.com/uprel/gisapp
 *
 */
Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null==this)throw new TypeError("this is null or not defined");var e=Object(this),f=e.length>>>0;if("[object Function]"!=={}.toString.call(a))throw new TypeError(a+" is not a function");b&&(c=b);for(d=0;d<f;){var h;Object.prototype.hasOwnProperty.call(e,d)&&(h=e[d],a.call(c,h,d,e));d++}});Eqwc.common={};Eqwc.common.createHyperlink=function(a,b,c){null==b&&(b=a);""!=a&&/^((http|https|ftp):\/\/).+\..+/i.test(a)&&(/\<a./i.test(a)||(a='<a class="link" href="'+a+'" target="_blank">'+b+"</a>"));""<c&&RegExp(c,"i").test(a)&&(a='<a href="/'+a+'" target="_blank">'+b+"</a>");return a};
Eqwc.common.manageFile=function(a,b){var c=!1;if(b){var d=a.split(".")[1].toLowerCase();if("jpg"==d||"jpeg"==d||"gif"==d||"png"==d)c=!0}d=window.location.origin;d=1==projectData.uploadDir.split(".").length?d+projectData.uploadDir:d+projectData.uploadDir.split(".")[1];return c?"<a target='_blank' href='"+d+a+"'><img src='"+d+"thumb/"+a+"'></a>":Eqwc.common.createHyperlink(d+a,a,null)};
Eqwc.common.getRasterFieldName=function(a,b){return Eqwc.settings.overWriteRasterFieldName&&Eqwc.settings.overWriteRasterFieldName[a]?Eqwc.settings.overWriteRasterFieldName[a][0]==b?Eqwc.settings.overWriteRasterFieldName[a][1]:b:b};Eqwc.common.layerFieldNameExists=function(a,b){for(var c=wmsLoader.layerProperties[a],d=0;d<c.attributes.length;d++)if(c.attributes[d].name==b)return!0;return!1};Eqwc.common.lookup=function(a,b,c){for(var d=0,e=a.length;d<e;d++)if(a[d]&&a[d][b]===c)return a[d]};Ext.ns("Ext.ux.data");
Ext.ux.data.PagingStore=Ext.extend(Ext.data.Store,{add:function(a){a=[].concat(a);if(!(1>a.length)){for(var b=0,c=a.length;b<c;b++)a[b].join(this);b=this.data.length;this.data.addAll(a);this.allData&&this.allData.addAll(a);this.snapshot&&this.snapshot.addAll(a);this.totalLength+=a.length;this.fireEvent("add",this,a,b)}},remove:function(a){if(Ext.isArray(a))Ext.each(a,function(a){this.remove(a)},this);else if(this==a.store){a.join(null);var b=this.data.indexOf(a);-1<b&&this.data.removeAt(b);this.pruneModifiedRecords&&
this.modified.remove(a);this.allData&&this.allData.remove(a);this.snapshot&&this.snapshot.remove(a);this.totalLength--; -1<b&&this.fireEvent("remove",this,a,b)}},removeAll:function(a){var b=[].concat((this.snapshot||this.allData||this.data).items);this.clearData();this.pruneModifiedRecords&&(this.modified=[]);this.totalLength=0;!0!==a&&this.fireEvent("clear",this,b)},insert:function(a,b){b=[].concat(b);for(var c=0,d=b.length;c<d;c++)this.data.insert(a,b[c]),b[c].join(this);this.allData&&this.allData.addAll(b);
this.snapshot&&this.snapshot.addAll(b);this.totalLength+=b.length;this.fireEvent("add",this,b,a)},getById:function(a){return(this.snapshot||this.allData||this.data).key(a)},clearData:function(){this.allData&&(this.data=this.allData,delete this.allData);this.snapshot&&(this.data=this.snapshot,delete this.snapshot);this.data.each(function(a){a.join(null)});this.data.clear()},execute:function(a,b,c,d){if(!Ext.data.Api.isAction(a))throw new Ext.data.Api.Error("execute",a);c=Ext.applyIf(c||{},{params:{}});
void 0!==d&&this.addToBatch(d);var e=!0;"read"===a?(e=this.fireEvent("beforeload",this,c),Ext.applyIf(c.params,this.baseParams)):(!0===this.writer.listful&&!0!==this.restful?b=Ext.isArray(b)?b:[b]:Ext.isArray(b)&&1==b.length&&(b=b.shift()),!1!==(e=this.fireEvent("beforewrite",this,a,b,c))&&this.writer.apply(c.params,this.baseParams,a,b));if(!1!==e){this.writer&&this.proxy.url&&!this.proxy.restful&&!Ext.data.Api.hasUniqueUrl(this.proxy,a)&&(c.params.xaction=a);if("read"===a&&this.isPaging(Ext.apply({},
c.params)))return function(){this.allData&&(this.data=this.allData,delete this.allData);this.applyPaging();this.fireEvent("datachanged",this);var a=[].concat(this.data.items);this.fireEvent("load",this,a,c);c.callback&&c.callback.call(c.scope||this,a,c,!0)}.defer(1,this),!0;this.proxy.request(Ext.data.Api.actions[a],b,c.params,this.reader,this.createCallback(a,b,d),this,c)}return e},loadRecords:function(a,b,c){if(!0!==this.isDestroyed)if(a&&!1!==c){c=a.records;a=a.totalRecords||c.length;if(b&&!0===
b.add)this.totalLength=Math.max(a,this.data.length+c.length),this.add(c);else{this.pruneModifiedRecords&&(this.modified=[]);for(var d=0,e=c.length;d<e;d++)c[d].join(this);this.clearData();this.data.addAll(c);this.totalLength=a;this.applySort();this.allData||this.applyPaging();c.length>this.getCount()&&(c=[].concat(this.data.items));this.fireEvent("datachanged",this)}this.fireEvent("load",this,c,b);b.callback&&b.callback.call(b.scope||this,c,b,!0)}else!1!==c&&this.fireEvent("load",this,[],b),b.callback&&
b.callback.call(b.scope||this,[],b,!1,a)},loadData:function(a,b){this.isPaging(Ext.apply({},this.lastOptions?this.lastOptions.params:null,this.baseParams));var c=this.reader.readRecords(a);this.loadRecords(c,{add:b},!0)},getTotalCount:function(){return this.allData?this.allData.getCount():this.totalLength||0},sortData:function(){var a=this.hasMultiSort?this.multiSortInfo:this.sortInfo,b=a.direction||"ASC",c=a.sorters,d=[];this.hasMultiSort||(c=[{direction:b,field:a.field}]);for(var a=0,e=c.length;a<
e;a++)d.push(this.createSortFunction(c[a].field,c[a].direction));if(d.length){var f="DESC"==b.toUpperCase()?-1:1,c=function(a,b){var c=d[0].call(this,a,b);if(1<d.length)for(var e=1,l=d.length;e<l;e++)c=c||d[e].call(this,a,b);return f*c};this.allData&&(this.data=this.allData,delete this.allData);this.data.sort(b,c);this.snapshot&&this.snapshot!=this.data&&this.snapshot.sort(b,c);this.applyPaging()}},filterBy:function(a,b){this.snapshot=this.snapshot||this.allData||this.data;this.data=this.queryBy(a,
b||this);this.applyPaging();this.fireEvent("datachanged",this)},clearFilter:function(a){this.isFiltered()&&(this.data=this.snapshot,delete this.snapshot,delete this.allData,this.applyPaging(),!0!==a&&this.fireEvent("datachanged",this))},isFiltered:function(){return!!this.snapshot&&this.snapshot!=(this.allData||this.data)},queryBy:function(a,b){return(this.snapshot||this.allData||this.data).filterBy(a,b||this)},collect:function(a,b,c){c=(!0===c?this.snapshot||this.allData||this.data:this.data).items;
for(var d,e,f=[],h={},g=0,k=c.length;g<k;g++)d=c[g].data[a],e=String(d),!b&&Ext.isEmpty(d)||h[e]||(h[e]=!0,f[f.length]=d);return f},findInsertIndex:function(a){this.suspendEvents();var b=this.data.clone();this.data.add(a);this.applySort();a=this.data.indexOf(a);this.data=b;this.totalLength--;this.resumeEvents();return a},isPaging:function(a){var b=this.paramNames,c=a[b.start],d=a[b.limit];if("number"!=typeof c||"number"!=typeof d)return delete this.start,delete this.limit,this.lastParams=a,!1;this.start=
c;this.limit=d;delete a[b.start];delete a[b.limit];b=this.lastParams;this.lastParams=a;if(!this.proxy)return!0;if(!b)return!1;for(var e in a)if(a.hasOwnProperty(e)&&a[e]!==b[e])return!1;for(e in b)if(b.hasOwnProperty(e)&&a[e]!==b[e])return!1;return!0},applyPaging:function(){var a=this.start,b=this.limit;if("number"==typeof a&&"number"==typeof b){var c=this.data,d=new Ext.util.MixedCollection(c.allowFunctions,c.getKey);d.items=c.items.slice(a,a+b);d.keys=c.keys.slice(a,a+b);for(var a=d.length=d.items.length,
b={},e=0;e<a;e++){var f=d.items[e];b[d.getKey(f)]=f}d.map=b;this.allData=c;this.data=d}}});Ext.ux.data.PagingDirectStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.DirectStore.prototype.constructor});Ext.reg("pagingdirectstore",Ext.ux.data.PagingDirectStore);Ext.ux.data.PagingJsonStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.JsonStore.prototype.constructor});Ext.reg("pagingjsonstore",Ext.ux.data.PagingJsonStore);
Ext.ux.data.PagingXmlStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.XmlStore.prototype.constructor});Ext.reg("pagingxmlstore",Ext.ux.data.PagingXmlStore);Ext.ux.data.PagingArrayStore=Ext.extend(Ext.ux.data.PagingStore,{constructor:Ext.data.ArrayStore.prototype.constructor,loadData:function(a,b){if(!0===this.expandData){for(var c=[],d=0,e=a.length;d<e;d++)c[c.length]=[a[d]];a=c}Ext.ux.data.PagingArrayStore.superclass.loadData.call(this,a,b)}});Ext.reg("pagingarraystore",Ext.ux.data.PagingArrayStore);
Ext.ux.data.PagingSimpleStore=Ext.ux.data.PagingArrayStore;Ext.reg("pagingsimplestore",Ext.ux.data.PagingSimpleStore);Ext.ux.data.PagingGroupingStore=Ext.extend(Ext.ux.data.PagingStore,Ext.copyTo({},Ext.data.GroupingStore.prototype,"constructor remoteGroup groupOnSort groupDir clearGrouping groupBy sort applyGroupField applyGrouping getGroupState".split(" ")));Ext.reg("paginggroupingstore",Ext.ux.data.PagingGroupingStore);
Ext.ux.PagingToolbar=Ext.extend(Ext.PagingToolbar,{onLoad:function(a,b,c){this.rendered?(a=this.getParams(),this.cursor=c.params&&c.params[a.start]?c.params[a.start]:0,this.onChange()):this.dsLoaded=[a,b,c]},onChange:function(){var a=this.store.getTotalCount(),b=this.pageSize;this.cursor>=a&&(this.cursor=Math.ceil((a+1)/b)*b);var a=this.getPageData(),b=a.activePage,c=a.pages;this.afterTextItem.setText(String.format(this.afterPageText,a.pages));this.inputItem.setValue(b);this.first.setDisabled(1==
b);this.prev.setDisabled(1==b);this.next.setDisabled(b==c);this.last.setDisabled(b==c);this.refresh.enable();this.updateInfo();this.fireEvent("change",this,a)},onClear:function(){this.cursor=0;this.onChange()},doRefresh:function(){delete this.store.lastParams;this.doLoad(this.cursor)},bindStore:function(a,b){var c;!b&&this.store&&(a!==this.store&&this.store.autoDestroy?this.store.destroy():(this.store.un("beforeload",this.beforeLoad,this),this.store.un("load",this.onLoad,this),this.store.un("exception",
this.onLoadError,this),this.store.un("datachanged",this.onChange,this),this.store.un("add",this.onChange,this),this.store.un("remove",this.onChange,this),this.store.un("clear",this.onClear,this)),a||(this.store=null));a&&(a=Ext.StoreMgr.lookup(a),a.on({scope:this,beforeload:this.beforeLoad,load:this.onLoad,exception:this.onLoadError,datachanged:this.onChange,add:this.onChange,remove:this.onChange,clear:this.onClear}),c=!0);this.store=a;if(c)this.onLoad(a,null,{})}});Ext.reg("ux.paging",Ext.ux.PagingToolbar);
Ext.ux.grid.RowNumberer=Ext.extend(Ext.grid.RowNumberer,{renderer:function(a,b,c,d){this.rowspan&&(b.cellAttr='rowspan="'+this.rowspan+'"');a=c.store;return a.lastOptions.params&&void 0!=a.lastOptions.params.start&&void 0!=a.lastOptions.params.limit?a.lastOptions.params.limit*Math.floor(a.lastOptions.params.start/a.lastOptions.params.limit)+d+1:d+1}});Ext.ux.grid.filter.NumericFilter&&Ext.apply(Ext.ux.grid.filter.NumericFilter.prototype,{menuItemCfgs:{emptyText:"",selectOnFocus:!0,width:125}});function getRootUrl(a){return a.toString().replace(/^(.*\/\/[^\/?#]*).*$/,"$1")}
function makeLayer(a,b){if(null==a)return null;var c=Ext.util.JSON.decode(a.definition),d=a.title,e={};switch(a.type){case "Google":e=new OpenLayers.Layer.Google(d,c);break;case "OSM":e=new OpenLayers.Layer.OSM(d,null,c);break;case "XYZ":e=c.url.replace(/\/{/g,"/${");e=new OpenLayers.Layer.XYZ(d,e,c.options);break;case "Bing":e=new OpenLayers.Layer.Bing({name:d,type:c.imagerySet,key:c.key});break;case "WMTS":e=b;b||void 0==c.visibility||(e=c.visibility);e=new OpenLayers.Layer.WMTS({name:d,visibility:e,
url:c.url,layer:c.layer,requestEncoding:c.requestEncoding,matrixSet:c.matrixSet,matrixIds:eval(c.matrixIds),format:c.format,style:c.style,displayOutsideMaxExtent:!1,tileFullExtent:eval(c.tileFullExtent),tileOrigin:eval(c.tileOrigin),maxExtent:eval(c.maxExtent),zoomOffset:eval(c.zoomOffset),numZoomLevels:eval(c.numZoomLevels),maxResolution:eval(c.maxResolution),resolutions:eval(c.resolutions),serverResolutions:eval(c.serverResolutions)});break;case "WMS":c.options.visibility=b;b||void 0==c.visibility||
(c.options.visibility=c.visibility);var e=window.location.hostname,f=getRootUrl(c.url).split("//")[1];b||e!=f||(c.options.metadata="identify");e=new OpenLayers.Layer.WMS(d,c.url,c.params,c.options)}return e}projectData.setBaseLayers=function(a){var b=[],c=a?projectData.baseLayers():projectData.extraLayers();if(null!=c)for(var d=0;d<c.length;d++)b.push(makeLayer(c[d],a));return b};
projectData.getLegendUrl=function(a){var b="",b=wmsLoader.layerTitleNameMapping[a.layername];return b="gdal"==a.provider||"wms"==a.provider?iconDirectory+"raster.png":wmsURI+Ext.urlEncode({SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetLegendGraphics",FORMAT:"image/png",EXCEPTIONS:"application/vnd.ogc.se_inimage",BOXSPACE:1,LAYERSPACE:2,SYMBOLSPACE:1,SYMBOLHEIGHT:2,LAYERFONTSIZE:8,ITEMFONTSIZE:8,ICONLABELSPACE:2,LAYERTITLE:"FALSE",LAYERFONTCOLOR:"#FFFFFF",LAYERTITLESPACE:0,TRANSPARENT:!0,LAYERS:b,DPI:screenDpi})};
Eqwc.plugins={};
var lang=projectData.lang,customGetUrlParamsParser=null,serverAndCGI="/proxy",printServer=serverAndCGI,useGetProjectSettings=!0,showLayerOrderTab=!1,grayLayerNameWhenOutsideScale=!0,showMetaDataInLegend=!0,defaultIdentificationMode=void 0==Eqwc.settings.defaultIdentificationMode?"allLayers":Eqwc.settings.defaultIdentificationMode,useGeodesicMeasurement=!0,useGeoCodeSearchBox=null!=projectData.geoCode,iconDirectory="client/site/gis_icons/",coordinatePrecision=2,elevationPrecision=1,minimumAddressRange=
1E3,searchBoxQueryURL=projectData.wsgi?"/wsgi/search.wsgi?query=":null,searchBoxGetGeomURL=projectData.wsgi?"/wsgi/getSearchGeom.wsgi":null,autoActivateSearchGeometryLayer=!0,enablePermalink=!0,permaLinkURLShortener=null,enableBGMaps=!0,enableExtraLayers=!0,mediaurl="",suppressEmptyValues=!1,suppressInfoGeometry=!0,showFieldNamesInClickPopup=!0,showFeatureInfoLayerTitle=!0,tooltipTemplates={Country:{template:"Look for the country on Google Search: <a href='http://www.google.it/#output=search&q=<%name%>' target='_blank'><%name%></a>"}},
mapSearchPanelOutputRegion="default",mapThemeSwitcherActive=!1,themeSwitcherTemplate=null,titleBarText=Ext.decode(Eqwc.settings.title),headerLogoImg=projectData.client_logo,headerLogoHeight=24,headerLogoLink=Eqwc.settings.useGisPortal?Eqwc.settings.gisPortalRoot:projectData.client_url,headerTermsOfUseText=TR.logoutLabel,headerTermsOfUseLink="./admin/login.php?action=logout",authid=projectData.crs,qgisLayerTransparency=null==projectData.baseLayers()&&null==projectData.extraLayers()?!1:!0,MapOptions=
{projection:new OpenLayers.Projection(authid),units:"m",numZoomLevels:void 0==Eqwc.settings.numZoomLevels?22:Eqwc.settings.numZoomLevels,fractionalZoom:!enableBGMaps,zoomDuration:5,restrictedExtent:projectData.restrictToStartExtent?projectData.extent.split(","):null,controls:[]},LayerOptions={buffer:0,singleTile:!0,ratio:1,transitionEffect:"resize",projection:authid,displayOutsideMaxExtent:!0,tileOptions:{maxGetUrlLength:2048}},OverviewMapOptions={projection:new OpenLayers.Projection(authid),transitionEffect:"resize"},
OverviewMapSize=new OpenLayers.Size(200,200),OverviewMapMaximized=!1,fixedPrintResolution=Eqwc.settings.fixedPrintResolution,printCapabilities=Eqwc.settings.printCapabilities?Eqwc.settings.printCapabilities:{scales:[{name:"1:100",value:"100"},{name:"1:200",value:"200"},{name:"1:250",value:"250"},{name:"1:500",value:"500"},{name:"1:1'000",value:"1000"},{name:"1:2'000",value:"2000"},{name:"1:3'000",value:"3000"},{name:"1:5'000",value:"5000"},{name:"1:7'500",value:"7500"},{name:"1:10'000",value:"10000"},
{name:"1:12'000",value:"12000"},{name:"1:15'000",value:"15000"},{name:"1:20'000",value:"20000"},{name:"1:25'000",value:"25000"},{name:"1:30'000",value:"30000"},{name:"1:50'000",value:"50000"},{name:"1:75'000",value:"75000"},{name:"1:100'000",value:"100000"},{name:"1:250'000",value:"250000"},{name:"1:500'000",value:"500000"},{name:"1:750'000",value:"750000"},{name:"1:1'000'000",value:"1000000"},{name:"1:2'500'000",value:"2500000"},{name:"1:5'000'000",value:"5000000"},{name:"1:7'500'000",value:"7500000"},
{name:"1:10'000'000",value:"10000000"},{name:"1:15'000'000",value:"15000000"},{name:"1:20'000'000",value:"20000000"},{name:"1:25'000'000",value:"25000000"},{name:"1:30'000'000",value:"30000000"},{name:"1:35'000'000",value:"35000000"},{name:"1:50'000'000",value:"50000000"},{name:"1:60'000'000",value:"60000000"},{name:"1:75'000'000",value:"75000000"},{name:"1:100'000'000",value:"100000000"},{name:"1:125'000'000",value:"125000000"},{name:"1:150'000'000",value:"150000000"}],dpis:[{name:"150 dpi",value:"150"},
{name:"300 dpi",value:"300"},{name:"600 dpi",value:"600"},{name:"1200 dpi",value:"1200"}],layouts:[]};Eqwc.settings.symbolizersHighLightLayer||(Eqwc.settings.symbolizersHighLightLayer={Point:{pointRadius:4,graphicName:"circle",fillColor:"none",strokeWidth:4,strokeColor:"#00FFFF"},Line:{strokeWidth:4,strokeOpacity:1,strokeColor:"#00FFFF"},Polygon:{strokeWidth:4,strokeColor:"#00FFFF",fillColor:"none"}});
var sketchSymbolizersMeasureControls={Point:{pointRadius:4,graphicName:"square",fillColor:"#FFFFFF",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#FF0000"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#FF0000",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#FF0000",fillColor:"#FFFFFF",fillOpacity:0.3}},locationAccuracyStyle={fillColor:"#000",fillOpacity:0.1,strokeWidth:0},locationMarkerStyle={graphicName:"cross",strokeColor:"#f00",strokeWidth:2,fillOpacity:0,
pointRadius:10};OpenLayers.Renderer.symbol.arrow=[0,4,2,0,4,4,2,3,0,4];var projDef=CustomProj[authid];void 0!==projDef&&(OpenLayers.Projection.defaults[authid]={maxExtent:projDef.extent,yx:void 0!==projDef.yx?projDef.yx:!1});function customInit(){}
function customBeforeMapInit(){for(var a=projectData.tablesOnStart(),b=0;b<a.length;b++){var c=a[b],d=wmsLoader.layerTitleNameMapping[c],e=projectData.layers[d].wfs;0<=wmsLoader.projectSettings.capability.layerDrawingOrder.indexOf(d)&&(c=new QGIS.SearchPanel({useWmsRequest:!0,queryLayer:c,gridColumns:getLayerAttributes(c).columns,gridLocation:"bottom",gridTitle:c,gridResults:Eqwc.settings.limitAttributeFeatures,gridResultsPageSize:20,gridEditable:e,selectionLayer:c,formItems:[],doZoomToExtent:!0,
tabClosable:!1}),c.onSubmit(),c.on("featureselectioncleared",clearFeatureSelected),c.on("beforesearchdataloaded",showSearchPanelResults))}}
function customAfterMapInit(){layerTree.getNodeById("wmsNode").firstChild.cascade(function(a){if(a.isLeaf()&&a.attributes.checked){var b=wmsLoader.layerTitleNameMapping[a.text];if(0<=wmsLoader.projectSettings.capability.layerDrawingOrder.indexOf(b)){var c=projectData.getLegendUrl(void 0==projectData.layers[b]?{provider:"",layername:b}:projectData.layers[b]);Ext.DomHelper.insertAfter(a.getUI().getAnchor(),"<div id='legend_"+b+"'><img style='vertical-align: middle; margin-left: 50px' src=\""+c+'"/></div>')}}})}
function customAfterGetMapUrls(){}function customPostLoading(){}function customBeforePrint(){}function customAfterPrint(){}var customButtons=[];function customToolbarLoad(){Ext.iterate(Eqwc.plugins,function(a){this[a].customToolbarLoad()},Eqwc.plugins)}function customMapToolbarHandler(a,b){}
function customActionLayerTreeCheck(a){if(a.isLeaf()){var b=wmsLoader.layerTitleNameMapping[a.text];if(-1!=wmsLoader.projectSettings.capability.layerDrawingOrder.indexOf(b)){if("object"==typeof activatedEditors)var c=activatedEditors[b];a.attributes.checked?(void 0!=c&&editor.editMode&&c.editLayer.setVisibility(a.attributes.checked),Ext.get("legend_"+b)||(c=projectData.getLegendUrl(void 0==projectData.layers[b]?{provider:"",layername:b}:projectData.layers[b]),Ext.DomHelper.insertAfter(a.getUI().getAnchor(),
"<div id='legend_"+b+"'><img style='vertical-align: middle; margin-left: 50px' src=\""+c+'"/></div>'))):(void 0!=c&&c.editLayer.setVisibility(a.attributes.checked),(a=Ext.get("legend_"+b))&&a.remove())}}}function customActionOnZoomEvent(){}function customActionOnMoveEvent(){};var urlParams={},urlParamsOK=!0,wmsURI,printURI,wmsMapName,maxExtent,olBoundsRegexp=/^-*[\d\.]+,-*[\d\.]+,-*[\d\.]+,-*[\d\.]+$/,urlString="",format="image/png",origFormat=format,searchtables=projectData.wsgi?projectData.wsgi.searchtables:null,visibleLayers=null,visibleBackgroundLayer=null,initialLayerOrder=null,fullColorLayers=[];
if(customGetUrlParamsParser&&"function"===typeof customGetUrlParamsParser)customGetUrlParamsParser();else{var urlString=document.documentURI?document.documentURI:window.location.href,urlString=urlString.replace(/\+/g," "),urlArray=urlString.split("?"),norewrite;norewrite="cgi"===serverAndCGI.substr(serverAndCGI.length-3,3).toLowerCase()?!0:!1;if(!norewrite){var urlBaseArray=urlArray[0].split("/"),map=urlBaseArray.slice(4).join("/"),suffix="",dashpos=urlBaseArray[3].indexOf("-");-1!=dashpos&&(suffix=
urlBaseArray[3].substr(dashpos));wmsURI=serverAndCGI+suffix+"/"+map+"?";printURI=printServer+suffix+"/"+map+"?";wmsMapName=map}if(1<urlArray.length){urlParams=Ext.urlDecode(urlArray[1]);norewrite&&(void 0==urlParams.map?(alert(errMessageStartupMapParamString[lang]),urlParamsOK=!1):(wmsURI=serverAndCGI+"?map="+urlParams.map+"&",printURI=printServer+"?map="+urlParams.map+"&",wmsMapName=urlParams.map));null!=urlParams.visibleLayers&&(visibleLayers=""==urlParams.visibleLayers?[]:urlParams.visibleLayers.split(","));
enableBGMaps&&null!=urlParams.visibleBackgroundLayer&&(visibleBackgroundLayer=urlParams.visibleBackgroundLayer);null!=urlParams.initialLayerOrder&&""!=urlParams.initialLayerOrder&&(initialLayerOrder=urlParams.initialLayerOrder.split(","));null!=urlParams.fullColorLayers&&(fullColorLayers=""==urlParams.fullColorLayers?[]:urlParams.fullColorLayers.split(","));urlParams.format&&(format=urlParams.format);origFormat=format;urlParams.lang&&(availableLanguages[urlParams.lang]?lang=urlParams.lang:alert(errMessageInvalidLanguageCodeString1[lang]+
"'"+urlParams.lang+"'\n"+errMessageInvalidLanguageCodeString2[lang]+availableLanguages[lang].names[lang]+"."));urlParams.searchtables&&(searchtables=urlParams.searchtables);if(urlParams.startExtent)if(urlParams.startExtent.match(olBoundsRegexp)){var startExtentParams=urlParams.startExtent.split(",");if(parseFloat(startExtentParams[0])>parseFloat(startExtentParams[2])||parseFloat(startExtentParams[1])>parseFloat(startExtentParams[3]))urlParamsOK=!1}else urlParamsOK=!1,alert(errMessageExtentParamWrongPart1[lang]+
"startExtent"+errMessageExtentParamWrongPart2[lang]);if(urlParams.maxExtent)if(urlParams.maxExtent.match(olBoundsRegexp)){var maxExtentParams=urlParams.maxExtent.split(",");parseFloat(maxExtentParams[0])>parseFloat(maxExtentParams[2])||parseFloat(maxExtentParams[1])>parseFloat(maxExtentParams[3])?urlParamsOK=!1:maxExtent=new OpenLayers.Bounds(parseFloat(maxExtentParams[0]),parseFloat(maxExtentParams[1]),parseFloat(maxExtentParams[2]),parseFloat(maxExtentParams[3]))}else urlParamsOK=!1,alert(errMessageExtentParamWrongPart1[lang]+
"maxExtent"+errMessageExtentParamWrongPart2[lang])}else urlParamsOK=!norewrite}customAfterGetMapUrls();Ext.tree.TriStateNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{onCheckChange:function(){Ext.tree.TriStateNodeUI.superclass.onCheckChange.apply(this,arguments);for(var a=this.node;(a=a.parentNode)&&a.getUI().updateParent&&a.getUI().checkbox&&!a.getUI().isUpdating;)a.getUI().updateParent()},toggleCheck:function(){var a=Ext.tree.TriStateNodeUI.superclass.toggleCheck.apply(this,arguments);this.updateChild(a);return a},renderElements:function(a,b,c,d){Ext.tree.TriStateNodeUI.superclass.renderElements.apply(this,
arguments);this.updateChild(this.node.attributes.checked)},updateParent:function(){var a;this.node.eachChild(function(b){if(void 0===a)a=b.attributes.checked;else if(a!==b.attributes.checked)return a=this.grayedValue,!1},this);this.toggleCheck(a)},updateChild:function(a){"boolean"==typeof a&&(this.isUpdating=!0,this.node.eachChild(function(b){b.getUI().toggleCheck(a)},this),delete this.isUpdating)}});
Ext.tree.AsynchTriStateNodeUI=Ext.extend(Ext.tree.TriStateNodeUI,{updateChild:function(a){this.checkbox&&(!0===a?Ext.fly(this.ctNode).replaceClass("x-tree-branch-unchecked","x-tree-branch-checked"):!1===a?Ext.fly(this.ctNode).replaceClass("x-tree-branch-checked","x-tree-branch-unchecked"):Ext.fly(this.ctNode).removeClass(["x-tree-branch-checked","x-tree-branch-unchecked"]))},getChecked:function(){var a=this.node.parentNode?this.node.parentNode.ui.getChecked():this.grayedValue;return"boolean"==typeof a?
a:Ext.tree.TriStateNodeUI.superclass.getChecked.call(this)}});
Ext.override(Ext.tree.TreeNodeUI,{grayedValue:null,onDisableChange:function(a,b){this.disabled=b;this[b?"addClass":"removeClass"]("x-tree-node-disabled")},initEvents:function(){this.node.on("move",this.onMove,this);this.node.disabled&&(this.disabled=!0,this.addClass("x-tree-node-disabled"));this.node.hidden&&this.hide();var a=this.node.getOwnerTree();!(a.enableDD||a.enableDrag||a.enableDrop)||this.node.isRoot&&!a.rootVisible||Ext.dd.Registry.register(this.elNode,{node:this.node,handles:this.getDDHandles(),
isHandle:!1})},onDblClick:function(a){a.preventDefault();this.disabled||(this.animating||!this.node.isExpandable()||a.getTarget(".x-tree-checkbox",1)||this.node.toggle(),this.fireEvent("dblclick",this.node,a))},onCheckChange:function(){var a=this.isChecked();a!==this.node.attributes.checked&&(this.node.attributes.checked=a,this.fireEvent("checkchange",this.node,a))},toggleCheck:function(a){var b=this.checkbox;if(!b)return!1;void 0===a&&(a=!1===this.isChecked());!0===a?Ext.fly(b).replaceClass("x-tree-node-grayed",
"x-tree-node-checked"):!1!==a?Ext.fly(b).replaceClass("x-tree-node-checked","x-tree-node-grayed"):Ext.fly(b).removeClass(["x-tree-node-checked","x-tree-node-grayed"]);this.onCheckChange();return a},onCheckboxClick:function(){this.disabled||this.toggleCheck();var a=null==this.node.attributes.checked?!1:!this.node.attributes.checked,b=!a;if(this.node.isLeaf())a?this.node.ownerTree.checkedLeafs.push(this.node):this.node.ownerTree.checkedLeafs.remove(this.node),null!=layerOrderPanel&&b!=layerOrderPanel.layerVisible(wmsLoader.layerTitleNameMapping[this.node.text])&&
layerOrderPanel.toggleLayerVisibility(wmsLoader.layerTitleNameMapping[this.node.text]),this.node.ownerTree.fireEvent("leafschange");else if(a&&!this.node.isExpanded())this.node.expand(!0,!1,function(a){a.cascade(function(a){a.isLeaf()&&null!=layerOrderPanel&&b!=layerOrderPanel.layerVisible(wmsLoader.layerTitleNameMapping[a.text])&&layerOrderPanel.toggleLayerVisibility(wmsLoader.layerTitleNameMapping[a.text])},this)}),this.node.ownerTree.fireEvent("leafschange"),this.node.collapse(!0,!1);else{var c=
0;this.node.cascade(function(a){a.isLeaf()&&null!=layerOrderPanel&&b!=layerOrderPanel.layerVisible(wmsLoader.layerTitleNameMapping[a.text])&&layerOrderPanel.toggleLayerVisibility(wmsLoader.layerTitleNameMapping[a.text]);c==this.node.childNodes.length&&this.node.ownerTree.fireEvent("leafschange");c++},this)}},onCheckboxOver:function(){this.addClass("x-tree-checkbox-over")},onCheckboxOut:function(){this.removeClass("x-tree-checkbox-over")},onCheckboxDown:function(){this.addClass("x-tree-checkbox-down")},
onCheckboxUp:function(){this.removeClass("x-tree-checkbox-down")},renderElements:function(a,b,c,d){this.indentMarkup=a.parentNode?a.parentNode.ui.getChildIndent():"";var e=void 0!==b.checked;b=['<li class="x-tree-node"><div ext:tree-node-id="',a.id,'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',b.cls,'" unselectable="on"><span class="x-tree-node-indent">',this.indentMarkup,'</span><img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow" /><img src="',b.icon||this.emptyIcon,'" class="x-tree-node-icon',
b.icon?" x-tree-node-inline-icon":"",b.iconCls?" "+b.iconCls:"",'" unselectable="on" />',e?'<img src="'+this.emptyIcon+'" class="x-tree-checkbox'+(!0===b.checked?" x-tree-node-checked":!1!==b.checked?" x-tree-node-grayed":"")+'" />':"",'<a hidefocus="on" class="x-tree-node-anchor" tabIndex="1" ',b.hrefTarget?' target="'+b.hrefTarget+'"':"",'><span unselectable="on">',a.text,'</span></a></div><ul class="x-tree-node-ct" style="display:none;"></ul></li>'].join("");var f;!0!==d&&a.nextSibling&&(f=a.nextSibling.ui.getEl())?
this.wrap=Ext.DomHelper.insertHtml("beforeBegin",f,b):this.wrap=Ext.DomHelper.insertHtml("beforeEnd",c,b);this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1];a=this.elNode.childNodes;this.indentNode=a[0];this.ecNode=a[1];this.iconNode=a[2];c=3;e&&(this.checkbox=a[3],c++);this.anchor=a[c];this.textNode=a[c].firstChild},isChecked:function(){return this.checkbox?Ext.fly(this.checkbox).hasClass("x-tree-node-checked")?!0:Ext.fly(this.checkbox).hasClass("x-tree-node-grayed")?this.grayedValue:
!1:!1},getChecked:function(){return this.node.attributes.checked}});
Ext.override(Ext.tree.TreeEventModel,{initEvents:function(){var a=this.tree.getTreeEl();a.on("click",this.delegateClick,this);!1!==this.tree.trackMouseOver&&(a.on("mouseover",this.delegateOver,this),a.on("mouseout",this.delegateOut,this));a.on("mousedown",this.delegateDown,this);a.on("mouseup",this.delegateUp,this);a.on("dblclick",this.delegateDblClick,this);a.on("contextmenu",this.delegateContextMenu,this)},delegateOver:function(a,b){if(this.beforeEvent(a)&&(this.lastEcOver&&(this.onIconOut(a,this.lastEcOver),
delete this.lastEcOver),this.lastCbOver&&(this.onCheckboxOut(a,this.lastCbOver),delete this.lastCbOver),a.getTarget(".x-tree-ec-icon",1)?(this.lastEcOver=this.getNode(a),this.onIconOver(a,this.lastEcOver)):a.getTarget(".x-tree-checkbox",1)&&(this.lastCbOver=this.getNode(a),this.onCheckboxOver(a,this.lastCbOver)),this.getNodeTarget(a)))this.onNodeOver(a,this.getNode(a))},delegateOut:function(a,b){if(this.beforeEvent(a)){var c;a.getTarget(".x-tree-ec-icon",1)?(c=this.getNode(a),this.onIconOut(a,c),
c==this.lastEcOver&&delete this.lastEcOver):a.getTarget(".x-tree-checkbox",1)&&(c=this.getNode(a),this.onCheckboxOut(a,c),c==this.lastCbOver&&delete this.lastCbOver);if((b=this.getNodeTarget(a))&&!a.within(b,!0))this.onNodeOut(a,this.getNode(a))}},delegateDown:function(a,b){if(this.beforeEvent(a)&&a.getTarget(".x-tree-checkbox",1))this.onCheckboxDown(a,this.getNode(a))},delegateUp:function(a,b){if(this.beforeEvent(a)&&a.getTarget(".x-tree-checkbox",1))this.onCheckboxUp(a,this.getNode(a))},delegateClick:function(a,
b){if(this.beforeEvent(a))if(a.getTarget(".x-tree-checkbox",1))this.onCheckboxClick(a,this.getNode(a));else if(a.getTarget(".x-tree-ec-icon",1))this.onIconClick(a,this.getNode(a));else if(this.getNodeTarget(a))this.onNodeClick(a,this.getNode(a))},onCheckboxClick:function(a,b){b.ui.onCheckboxClick()},onCheckboxOver:function(a,b){b.ui.onCheckboxOver()},onCheckboxOut:function(a,b){b.ui.onCheckboxOut()},onCheckboxDown:function(a,b){b.ui.onCheckboxDown()},onCheckboxUp:function(a,b){b.ui.onCheckboxUp()}});
Ext.override(Ext.tree.TreePanel,{getChecked:function(a,b){b=b||this.root;var c=[];b.cascade(function(){this.ui.getChecked()&&c.push(a?"id"==a?this.id:this.attributes[a]:this)});return c}});objectIdentificationModes=Ext.extend(Ext.data.JsonStore,{constructor:function(a){a=a||{};objectIdentificationModes.superclass.constructor.call(this,Ext.apply({storeId:"objIdentificationModes",autoLoad:!0,data:{modes:[{name:objectIdentificationModeString.topMostHit[lang],value:"topMostHit"},{name:objectIdentificationModeString.allLayers[lang],value:"allLayers"},{name:objectIdentificationModeString.activeLayers[lang],value:"activeLayers"}]},root:"modes",fields:[{name:"name",type:"string",allowBlank:!1},
{name:"value",type:"string",allowBlank:!1}]},a))}});new objectIdentificationModes;
var layoutHeaderCfg={tag:"div",cls:"x-panel-header",id:"panel_header",children:[{tag:"div",id:"panel_header_link",html:"<a></a>"},{tag:"div",id:"panel_header_title",html:"",style:{cursor:"default"}},{tag:"div",id:"panel_header_terms_of_use",html:"<a></a>"},{tag:"div",id:"panel_header_user",html:'<a href="'+Eqwc.settings.gisPortalProfile+'" style="text-decoration-line: none;/*!  */color: inherit;"><img height="14px" src="'+userLogoImg+'"></img>'+projectData.user+"</a>&nbsp;"}]};
null!=headerLogoImg&&(layoutHeaderCfg.style="height: "+headerLogoHeight+"px;");
MyViewportUi=Ext.extend(Ext.Viewport,{layout:"fit",initComponent:function(){this.items=[{xtype:"panel",layout:"border",id:"GisBrowserPanel",headerCfg:layoutHeaderCfg,items:[{xtype:"panel",margins:"3 0 3 3",cmargins:"3 3 3 3",title:leftPanelTitleString[lang],height:333,width:225,collapsible:!0,boxMinWidth:200,boxMaxWidth:400,layout:"vbox",region:"west",floatable:!1,minWidth:200,split:!0,collapseMode:"standard",id:"LeftPanel",items:[{xtype:"button",height:"1.5em",width:"100%",text:mapThemeButtonTitleString[lang],
id:"mapThemeButton",tooltip:mapThemeButtonTooltipString[lang],enableToggle:!1,allowDepress:!1,flex:0.1,hidden:!0},{xtype:"panel",layout:"accordion",border:!1,frame:!1,id:"collapsiblePanels",flex:0.9,width:"100%",layoutConfig:{titleCollapse:!0,animate:!0,activeOnTop:!1},activeItem:2,items:[{id:"DescriptionPanel",xtype:"panel",title:TR.description,html:projectData.description,hidden:!0,padding:5,autoScroll:!0},{xtype:"panel",title:searchPanelTitleString[lang],id:"SearchPanel",border:!1,frame:!1,items:[{xtype:"tabpanel",
enableTabScroll:!0,activeTab:0,id:"SearchTabPanel",items:[]}]},{xtype:"panel",title:layerTreeTitleString[lang],layout:"border",id:"leftPanelMap",border:!1,frame:!1,items:[{xtype:"treepanel",lines:!1,border:!1,frame:!1,title:"",height:159,split:!0,region:"center",collapsible:!1,rootVisible:!1,autoScroll:!0,cls:"x-tree-noicon",id:"LayerTree",root:{text:"Root",expanded:!0,singleClickExpand:!0},loader:{}}]}]}]},{xtype:"panel",border:!1,frame:!1,margins:"3 3 3 0",flex:1,region:"center",width:100,layout:"border",
id:"CenterPanel",items:[{xtype:"panel",region:"center",tpl:"",layout:"fit",id:"MapPanel",tbar:{xtype:"toolbar",autoHeight:!0,id:"myTopToolbar",items:[{xtype:"tbseparator",id:"separator1"},{xtype:"button",tooltip:objIdentificationTooltipString[lang],toggleGroup:"mapTools",enableToggle:!0,icon:iconDirectory+"mActionIdentify.png",allowDepress:!0,tooltipType:"qtip",iconCls:"",scale:"medium",id:"IdentifyTool",hidden:!1},{xtype:"tbtext",text:objectIdentificationTextLabel[lang],id:"ObjectIdentificationText",
hidden:!projectData.identify_mode},{xtype:"combo",width:120,store:"objIdentificationModes",valueField:"value",mode:"local",displayField:"name",triggerAction:"all",id:"ObjectIdentificationModeCombo",hidden:!projectData.identify_mode},{xtype:"button",enableToggle:!0,allowDepress:!0,toggleGroup:"mapTools",icon:iconDirectory+"mActionMeasure.png",tooltip:measureDistanceTooltipString[lang],tooltipType:"qtip",scale:"medium",id:"measureDistance",hidden:!projectData.measurements},{xtype:"button",enableToggle:!0,
allowDepress:!0,toggleGroup:"mapTools",scale:"medium",icon:iconDirectory+"mActionMeasureArea.png",tooltipType:"qtip",tooltip:measureAreaTooltipString[lang],id:"measureArea",hidden:!projectData.measurements},{xtype:"tbseparator",id:"separator3"},{xtype:"button",enableToggle:!0,allowDepress:!0,toggleGroup:"mapTools",scale:"medium",icon:iconDirectory+"mActionFilePrint.png",tooltipType:"qtip",tooltip:printMapTooltipString[lang],id:"PrintMap",hidden:!projectData.print},{xtype:"button",enableToggle:!1,
allowDepress:!1,scale:"medium",icon:iconDirectory+"mActionPermalink.png",tooltipType:"qtip",tooltip:sendPermalinkTooltipString[lang],id:"SendPermalink",hidden:!projectData.permalink},{xtype:"tbseparator",id:"separator4"},{xtype:"button",enableToggle:!1,allowDepress:!1,scale:"medium",icon:iconDirectory+"mActionMailSend.png",tooltipType:"qtip",tooltip:TR.feedback,id:"ShowFeedback",handler:mapToolbarHandler,hidden:!projectData.userFeedback}]},bbar:{xtype:"toolbar",id:"myBottomToolbar",items:[{xtype:"tbtext",
text:mapAppLoadingString[lang],id:"mainStatusText"},{xtype:"tbfill"},{xtype:"tbtext",text:"",id:"rightStatusText"},{xtype:"tbtext",text:coordinateTextLabel[lang]},{xtype:"tbspacer"},{xtype:"textfield",width:120,regex:/^\d{6}\.?\d{0,2},\d{6}\.?\d{0,2}$/,enableKeyEvents:!0,id:"CoordinateTextField"},{xtype:"tbtext",text:"1:"},{xtype:"numberfield",minValue:1,allowNegative:!1,allowDecimals:!1,width:65,enableKeyEvents:!0,id:"ScaleNumberField"}]}}]},{xtype:"panel",id:"RightPanel",title:"",region:"east",
split:!0,collapsible:!0,collapsed:!0,hidden:!0,width:300},{xtype:"tabpanel",id:"BottomPanel",title:"",region:"south",split:!0,collapsible:!0,collapsed:!0,hidden:!1,height:300,listeners:{tabchange:function(){0==this.items.getCount()&&this.collapse()}}}]}];this.items[0].items[1].items[0].tbar.items=this.items[0].items[1].items[0].tbar.items.concat(customButtons);MyViewportUi.superclass.initComponent.call(this)}});MyViewport=Ext.extend(MyViewportUi,{initComponent:function(){MyViewport.superclass.initComponent.call(this)}});
Ext.onReady(function(){Ext.QuickTips.init();(new MyViewport({renderTo:Ext.getBody()})).show()});window.QGIS||(window.QGIS={});QGIS.WMSCapabilitiesLoader=function(a){Ext.apply(this,a);QGIS.WMSCapabilitiesLoader.superclass.constructor.call(this,a)};
Ext.extend(QGIS.WMSCapabilitiesLoader,GeoExt.tree.WMSCapabilitiesLoader,{useGetProjectSettings:!0,WMSCapabilities:null,projectSettings:null,layerProperties:[],layerTitleNameMapping:[],initialVisibleLayers:[],getParams:function(a){return{SERVICE:"WMS",VERSION:"1.3",REQUEST:this.useGetProjectSettings?"GetProjectSettings":"GetCapabilities"}},processResponse:function(a,b,c,d){a.responseXML?this.WMSCapabilities=a.responseXML:window.DOMParser?this.WMSCapabilities=(new DOMParser).parseFromString(a.responseText,
"text/xml"):(this.WMSCapabilities=new ActiveXObject("Microsoft.XMLDOM"),this.WMSCapabilities.async="false",this.WMSCapabilities.loadXML(a.responseText));this.projectSettings=(new OpenLayers.Format.WMSCapabilities({readers:{wms:OpenLayers.Util.applyDefaults({ComposerTemplates:function(a,b){b.composerTemplates=[];this.readChildNodes(a,b.composerTemplates)},ComposerTemplate:function(a,b){var c={name:a.getAttribute("name"),width:parseInt(a.getAttribute("width")),height:parseInt(a.getAttribute("height"))};
this.readChildNodes(a,c);b.push(c)},ComposerMap:function(a,b){b.map={name:a.getAttribute("name"),width:parseInt(a.getAttribute("width")),height:parseInt(a.getAttribute("height"))}},ExclusiveLayerGroups:function(a,b){b.exclusiveLayerGroups=[];this.readChildNodes(a,b.exclusiveLayerGroups)},group:function(a,b){b.push(this.getChildValue(a).split(","))},LayerDrawingOrder:function(a,b){b.layerDrawingOrder=this.getChildValue(a).split(",")},Layer:function(a,b){var c,d;b.capability?(d=b.capability,c=b):d=
b;var e=a.getAttributeNode("queryable"),l=e&&e.specified?a.getAttribute("queryable"):null,p=(e=a.getAttributeNode("cascaded"))&&e.specified?a.getAttribute("cascaded"):null,q=(e=a.getAttributeNode("opaque"))&&e.specified?a.getAttribute("opaque"):null,u=(e=a.getAttributeNode("visible"))&&e.specified?a.getAttribute("visible"):null,m=a.getAttribute("displayField"),r=(e=a.getAttributeNode("checkbox"))&&e.specified?a.getAttribute("checkbox"):null,v=(e=a.getAttributeNode("legend"))&&e.specified?a.getAttribute("legend"):
null,e=(e=a.getAttributeNode("metadata"))&&e.specified?a.getAttribute("metadata"):null,t=a.getAttribute("noSubsets"),x=a.getAttribute("fixedWidth"),y=a.getAttribute("fixedHeight"),s=c||{},w=OpenLayers.Util.extend;c={nestedLayers:[],styles:c?[].concat(c.styles):[],srs:c?w({},s.srs):{},metadataURLs:[],bbox:c?w({},s.bbox):{},llbbox:s.llbbox,dimensions:c?w({},s.dimensions):{},authorityURLs:c?w({},s.authorityURLs):{},identifiers:{},keywords:[],queryable:l&&""!==l?"1"===l||"true"===l:s.queryable||!1,cascaded:null!==
p?parseInt(p):s.cascaded||0,opaque:q?"1"===q||"true"===q:s.opaque||!1,visible:u&&""!==u?"1"===u||"true"===u:!0,displayField:m,showCheckbox:r&&""!==r?"1"===r||"true"===r:!0,showLegend:v&&""!==v?"1"===v||"true"===v:!0,showMetadata:e&&""!==e?"1"===e||"true"===e:!0,noSubsets:null!==t?"1"===t||"true"===t:s.noSubsets||!1,fixedWidth:null!=x?parseInt(x):s.fixedWidth||0,fixedHeight:null!=y?parseInt(y):s.fixedHeight||0,minScale:s.minScale,maxScale:s.maxScale,attribution:s.attribution};c.capability=d;this.readChildNodes(a,
c);delete c.capability;b.nestedLayers.push(c);c.name&&(l=c.name.split(":"),p=d.request,q=p.getfeatureinfo,0<l.length&&(c.prefix=l[0]),d.layers.push(c),void 0===c.formats&&(c.formats=p.getmap.formats),void 0===c.infoFormats&&q&&(c.infoFormats=q.formats))},Attributes:function(a,b){b.attributes=[];this.readChildNodes(a,b.attributes)},Attribute:function(a,b){var c={name:validateFieldName(a.getAttribute("name")),alias:a.getAttribute("alias"),type:a.getAttribute("type"),precision:parseInt(a.getAttribute("precision")),
length:parseInt(a.getAttribute("length")),editType:a.getAttribute("editType"),comment:a.getAttribute("comment")};b.push(c)},SRS:function(a,b){b.srs[this.getChildValue(a)]=!0}},OpenLayers.Format.WMSCapabilities.v1_3.prototype.readers.wms)}})).read(this.WMSCapabilities);this.processLayer(this.projectSettings.capability,this.projectSettings.capability.request.getmap.href,b);for(a=0;a<this.projectSettings.capability.layers.length;a++){var e=this.projectSettings.capability.layers[a];this.layerProperties[e.name]=
{name:e.name,title:e.title,"abstract":e["abstract"],visible:e.visible,opacity:255,queryable:e.queryable,displayField:e.displayField,nrChildLayers:e.nestedLayers.length,attributes:e.attributes,srsList:e.srs,bbox:e.llbbox,minScale:null!=e.minScale?parseFloat(e.minScale):null,maxScale:null!=e.maxScale?parseFloat(e.maxScale):null,showLegend:e.showLegend,showMetadata:e.showMetadata};this.layerTitleNameMapping[e.title]=e.name;e.visible&&this.initialVisibleLayers.push(e.name)}void 0===this.projectSettings.capability.composerTemplates&&
(this.projectSettings.capability.composerTemplates=[]);void 0===this.projectSettings.capability.exclusiveLayerGroups&&(this.projectSettings.capability.exclusiveLayerGroups=[]);"function"==typeof c&&c.apply(d||b,[b])},createWMSLayer:function(a,b){return a.name?new OpenLayers.Layer.WMS(a.title,b,OpenLayers.Util.extend({formats:a.formats[0],layers:a.name},this.layerParams),OpenLayers.Util.extend({minScale:a.minScale,queryable:a.queryable,maxScale:a.maxScale,visible:a.visible,metadata:a},this.layerOptions)):
null},findLayerNodeByName:function(a){a='//opengis:Layer/opengis:Name[text()="'+a+'"]/..';var b=void 0;"function"==typeof this.WMSCapabilities.evaluate?(xpathResult=this.WMSCapabilities.evaluate(a,this.WMSCapabilities.firstChild,this.nsResolver,XPathResult.ANY_TYPE,null),4==xpathResult.resultType&&(b=xpathResult.iterateNext())):(this.WMSCapabilities.setProperty("SelectionLanguage","XPath"),this.WMSCapabilities.setProperty("SelectionNamespaces","xmlns:opengis='http://www.opengis.net/wms'"),b=this.WMSCapabilities.selectSingleNode(a));
return b},nsResolver:function(a){return{opengis:"http://www.opengis.net/wms"}[a]||null}});function validateFieldName(a){var b="";return b=a.replace(/\./g,"")}QGIS.PrintProvider=function(a){Ext.apply(this,a);QGIS.PrintProvider.superclass.constructor.call(this,a)};
Ext.extend(QGIS.PrintProvider,GeoExt.data.PrintProvider,{print:function(a,b,c){a instanceof GeoExt.MapPanel&&(a=a.map);b=b instanceof Array?b:[b];c=c||{};if(!1!==this.fireEvent("beforeprint",this,a,b,c)){var d=printExtent.page.scale.get("value"),e=10;100<d&&250>=d?e=25:250<d&&1E3>=d?e=50:1E3<d&&2500>=d?e=100:2500<d&&5E3>=d?e=250:5E3<d&&12E3>=d?e=500:12E3<d&&25E3>=d?e=1E3:25E3<d&&5E4>=d?e=2E3:5E4<d&&1E5>=d?e=5E3:1E5<d&&5E5>=d?e=1E4:5E5<d&&1E6>=d?e=5E4:1E6<d&&5E6>=d?e=1E5:5E6<d&&1E7>=d?e=25E4:1E7<d&&
5E7>=d?e=25E5:5E7<d&&1E8>=d?e=5E6:1E8<d&&(e=1E7);printResolution=null!=fixedPrintResolution&&0<parseInt(fixedPrintResolution)?fixedPrintResolution:this.dpi.get("value");var f=thematicLayer.params.LAYERS,h=wmsLoader.layerTitleNameMapping[currentlyVisibleBaseLayer];void 0!=h&&(f=h+","+f);var g=this.url+"&"+Ext.urlEncode({SRS:authid,DPI:printResolution,TEMPLATE:this.layout.get("name"),"map0:extent":printExtent.page.getPrintExtent(a).toBBOX(1,!1),"map0:scale":d,"map0:rotation":-1*printExtent.page.rotation,
"map0:grid_interval_x":e,"map0:grid_interval_y":e,LAYERS:f}),g=g+("&"+Ext.urlEncode(this.customParams));thematicLayer.params.OPACITIES&&(g+="&OPACITIES="+encodeURIComponent(thematicLayer.params.OPACITIES));d=printExtent.page.getPrintExtent(a).getCenterLonLat();d=new OpenLayers.Geometry.Point(d.lon,d.lat);d=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Spatial.INTERSECTS,value:d});Ext.getBody().mask(printLoadingString[lang],"x-mask-loading");d=new OpenLayers.Protocol.WFS({url:printURI,featureType:"print",
geometryName:"geometry",srsName:authid,filter:d,readWithPOST:!0});this.fireEvent("afterprint",this,a,b,c);d.read({callback:function(a){try{if(null!=a.features&&0<a.features.length)for(key in attributes=a.features[0].attributes,attributes)g+="&"+key+"="+encodeURIComponent(attributes[key])}catch(b){}this.download(g)},scope:this})}},download:function(a){!1!==this.fireEvent("beforedownload",this,a)&&(Ext.getCmp("geoExtMapPanel"),(new Ext.Window({title:printWindowTitleString[lang],width:Ext.getBody().getWidth()-
100,height:Ext.getBody().getHeight()-100,resizable:!0,closable:!0,constrain:!0,constrainHeader:!0,x:50,y:50,html:'<object data="'+a+'" type="application/pdf" width="100%" height="100%"><p style="margin:5px;">'+printingObjectDataAlternativeString1[lang]+a+printingObjectDataAlternativeString2[lang]})).show(),Ext.getBody().unmask());this.fireEvent("print",this,a)}});
QGIS.SearchComboBox=Ext.extend(Ext.form.ComboBox,{map:null,highlightLayerName:null,highlightLayer:null,hasReverseAxisOrder:!1,url:null,geomUrl:null,hideTrigger:!1,minChars:2,queryDelay:50,displayField:"label",forceSelection:!0,searchtables:null,srs:null,initComponent:function(){this.emptyText=searchFieldDefaultTextString[lang];this.triggerConfig={tag:"img",src:Ext.BLANK_IMAGE_URL,cls:"x-form-trigger x-form-clear-trigger"};this.on("keyUp",this.keyUpHandler);this.on("afterrender",this.afterrenderHandler);
this.on("beforeselect",this.beforeselectHandler);this.store=new Ext.data.JsonStore({proxy:new Ext.data.ScriptTagProxy({url:this.url,method:"GET",callbackParam:"cb",nocache:!1,autoAbort:!0}),baseParams:{searchtables:this.getSearchTables(),srs:this.srs},root:"results",fields:"searchtable searchtext displaytext bbox showlayer selectable".split(" ")});this.tpl=(new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item {service}">','<tpl if="searchtable == null">',"<b>","</tpl>","{displaytext}",'<tpl if="searchtable == null">',
"</b>","</tpl>","</div></tpl>")).compile();QGIS.SearchComboBox.superclass.initComponent.call(this);this.highlightLayerName&&(this.highlightLayer=this.map.getLayersByName(this.highlightLayerName)[0]);this.on("select",this.recordSelected,this)},afterrenderHandler:function(){this.trigger.hide()},beforeselectHandler:function(a,b,c){"1"==b.get("selectable")&&this.collapse()},keyUpHandler:function(a,b){this.checkTrigger();Ext.isEmpty(this.getValue())&&this.resetSearch();this.getValue().length<this.minChars&&
this.collapse()},checkTrigger:function(){if(this.rendered)this.trigger[Ext.isEmpty(this.getValue())?"hide":"show"]()},onTriggerClick:function(){this.resetSearch();this.checkTrigger();this.focus()},onSelect:function(a,b){!1!==this.fireEvent("beforeselect",this,a,b)&&"1"==a.get("selectable")&&(this.setValue(a.get("displaytext")),this.fireEvent("select",this,a,b))},resetSearch:function(){this.collapse();this.clearSearchResult()},recordSelected:function(a,b,c){a=b.get("bbox");if(null!=a){a=OpenLayers.Bounds.fromArray(a,
this.hasReverseAxisOrder);c=a.getWidth();var d=a.getHeight();50>c?(centerX=a.left+0.5*c,a.left=centerX-25,a.right=centerX+25):(a.left-=0.05*c,a.right+=0.05*c);50>d?(centerY=a.bottom+0.5*d,a.bottom=centerY-25,a.top=centerY+25):(a.bottom-=d=0.05,a.top+=d=0.05);this.map.zoomToExtent(a)}this.highlightLayer&&Ext.Ajax.request({url:this.geomUrl,success:this.showSearchGeometry,failure:function(a,b){Ext.MessageBox.alert(errMessageSearchComboNetworkRequestFailureTitleString[lang],errMessageSearchComboNetworkRequestFailureString+
a.responseText)},method:"GET",params:{searchtable:b.get("searchtable"),showlayer:b.get("showlayer"),displaytext:b.get("displaytext"),srs:this.srs}})},showSearchGeometry:function(a,b){var c=b.params.showlayer?b.params.showlayer:b.params.searchtable,d=wmsLoader.layerTitleNameMapping[c];if("undefined"!=typeof autoActivateSearchGeometryLayer&&autoActivateSearchGeometryLayer&&-1!=allLayers.indexOf(d)){var e=!1;layerTree.root.cascade(function(a){a.text==c&&(e=a)});e&&(e.getUI().toggleCheck(!0),layerTree.fireEvent("leafschange"))}this.highlightLayer.removeAllFeatures();
d=new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(a.responseText));this.highlightLayer.addFeatures([d])},clearSearchResult:function(){this.setValue("");this.highlightLayer&&this.highlightLayer.removeAllFeatures()},getSearchTables:function(){returnVal=null;null!=this.searchtables&&(returnVal=this.searchtables);return returnVal}});Ext.reg("qgis_searchcombo",QGIS.SearchComboBox);
QGIS.SearchPanel=Ext.extend(Ext.Panel,{form:null,featureInfoParser:null,store:null,resultsGrid:null,useWmsRequest:!1,wmsFilter:"",queryLayer:"",formItems:[],gridColumns:[],selectionLayer:"",selectionZoom:4,gridLocation:"",gridTitle:"",gridResults:100,gridResultsPageSize:20,gridEditable:!1,tabClosable:!0,constructor:function(a){a=a||{};a.useWmsRequest=a.useWmsRequest||!1;null==a.tabClosable&&(a.tabClosable=!0);null==a.gridEditable&&(a.gridEditable=!1);a.queryLayer=a.queryLayer||"";a.wmsFilter=a.wmsFilter||
"";a.formItems=a.formItems||[];a.gridColumns=a.gridColumns||[];a.gridLocation=a.gridLocation||"";a.gridTitle=a.gridTitle||"";null==a.gridResults&&(a.gridResults=100);null==a.gridResultsPageSize&&(a.gridResultsPageSize=20);a.selectionLayer=a.selectionLayer||"";null==a.selectionZoom&&(a.selectionZoom=4);this.addEvents(["beforesearchdataloaded","aftersearchdataloaded","searchformsubmitted"]);QGIS.SearchPanel.superclass.constructor.call(this,a)},initComponent:function(){this.form=new Ext.form.FormPanel({autoHeight:!0,
bodyBorder:!1,padding:3,defaults:{anchor:"-10"},items:this.formItems,buttons:[{text:searchButtonString[lang],scope:this,handler:this.onSubmit},{text:resetButtonString[lang],scope:this,handler:function(){this.fireEvent("featureselectioncleared");this.form.getForm().reset()}}],keys:[{key:[Ext.EventObject.ENTER],handler:function(){this.onSubmit()},scope:this}]});this.featureInfoParser=new QGIS.FeatureInfoParser;Ext.apply(this,{layout:"fit",autoHeight:!0,items:[this.form]});QGIS.SearchPanel.superclass.initComponent.call(this);
this.addEvents("featureselected");this.addEvents("featureselectioncleared")},onSubmit:function(){if(null===this.form||!1!==this.form.getForm().isValid()){this.fireEvent("featureselectioncleared");this.fireEvent("searchformsubmitted");var a=this;"bottom"==this.gridLocation&&(a=Ext.getCmp("BottomPanel"));a.show();a.collapsible&&a.expand();this.useWmsRequest?null!==this.resultsGrid&&null!==this.resultsGrid.store?"BottomPanel"==a.id&&this.gridResults===this.resultsGrid.store.maxResults?a.activate(Ext.getCmp("table_"+
this.queryLayer)):(this.resultsGrid.store.maxResults=this.gridResults,this.submitGetFeatureInfo()):(a.el.mask(pleaseWaitString[lang],"x-mask-loading"),this.submitGetFeatureInfo()):this.submitForm()}},submitGetFeatureInfo:function(){var a=this.wmsFilter,b=wmsLoader.layerTitleNameMapping[this.queryLayer],c=!0;if(""==a){var a=[],d=this.form.getForm().getFieldValues(),e;for(e in d){var f=this.form.getForm().findField(e);if(d[e]){var h=f.initialConfig.filterOp?f.initialConfig.filterOp:"=";valueQuotes=
f.isXType("numberfield")?"":"'";valueExtra=-1<f.initialConfig.filterOp.indexOf("LIKE")?"%":"";a.push('"'+e+'" '+h+" "+valueQuotes+valueExtra+d[e]+valueExtra+valueQuotes);c&=f.validate()}}a=b+":"+a.join(" AND ")}else a=b+":"+a;c?Ext.Ajax.request({url:wmsURI,params:{SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetFeatureInfo",LAYERS:b,QUERY_LAYERS:b,FEATURE_COUNT:this.gridResults,INFO_FORMAT:"text/xml",SRS:authid,FILTER:a},method:"GET",scope:this,success:this.onSuccess,failure:this.onFormFailure}):this.showFailure("client")},
submitForm:function(){this.form.getForm().submit({url:wmsURI,method:"GET",scope:this,success:this.onFormSuccess,failure:this.onFormFailure})},onFormSuccess:function(a,b){this.onSuccess(b.response)},onSuccess:function(a){if(this.featureInfoParser.parseXML(a)){var b=this.featureInfoParser;a=b.featuresArray();var c=b.featureFields(),d=a.length,b=b.featuresBbox();if(null==this.store){var e=[];e.push({name:"feature_id"});for(var f=wmsLoader.layerProperties[wmsLoader.layerTitleNameMapping[this.queryLayer]].attributes,
h=0;h<f.length;h++){var g=f[h].type;"QDateTime"==g&&(g="date");"double"==g&&(g="float");e.push({name:f[h].name,type:g})}-1<c.indexOf("geometry")&&e.push({name:"geometry"});e.push({name:"bbox"});this.store=new Ext.ux.data.PagingArrayStore({idIndex:0,fields:e,lastOptions:{params:{start:0,limit:this.gridResultsPageSize}},totalCount:d,totalBbox:b,queryLayer:this.queryLayer,gridLocation:this.gridLocation,maxResults:this.gridResults,listeners:{datachanged:function(){var a=this.totalCount==this.maxResults?
!1:!0;if("bottom"==this.gridLocation){var b=this.totalCount,c=this.getTotalCount(),d=Ext.getCmp("table_"+this.queryLayer);if(void 0!=d){var e=d.getBottomToolbar().getComponent("loadmore");void 0!=e&&(a?e.setVisible(!1):e.setVisible(!0));c<b?d.setTitle(this.queryLayer+"* ("+c+")"):d.setTitle(this.queryLayer+" ("+b+")")}}else"default"==this.gridLocation&&(a=Ext.getCmp("SearchPanelResultsGrid"),a.setTitle(searchResultString[lang]+" ("+a.store.totalCount+")"))}}})}else this.store.totalCount=d,this.store.totalBbox=
b;this.fireEvent("beforesearchdataloaded",this,a);this.store.loadData(a,!1);a=this.el;"bottom"==this.gridLocation&&(a=Ext.getCmp("BottomPanel").el);a.unmask();this.fireEvent("aftersearchdataloaded",this)}else this.showFailure(this.featureInfoParser.serviceException())},onFormFailure:function(a,b){if(null!=a&&200==a.status)this.onSuccess(a);else this.showFailure(a.statusText)},showFailure:function(a){var b=this.el;"bottom"==this.gridLocation&&(b=Ext.getCmp("BottomPanel").el);b.unmask();"client"==a?
Ext.MessageBox.alert(searchPanelTitleString[lang],missingOrInvalidSearchParams[lang]):Ext.MessageBox.alert(searchErrorString[lang],a)},onRowClick:function(a,b,c){c=a.store.getAt(b);a=c.data.bbox;b=c.data.geometry;if(null!=a){c=c.id;var d=(a.minx+a.maxx)/2,e=(a.miny+a.maxy)/2,f=!1;this.hasOwnProperty("doZoomToExtent")&&(f=this.doZoomToExtent);this.fireEvent("featureselected",{layer:this.selectionLayer,id:c,x:d,y:e,geometry:b,bbox:new OpenLayers.Bounds(a.minx,a.miny,a.maxx,a.maxy),zoom:this.selectionZoom,
doZoomToExtent:f})}}});Ext.reg("qgis_searchpanel",QGIS.SearchPanel);
QGIS.FeatureInfoParser=Ext.extend(Object,{serviceExceptionMessage:"",fields:[],features:[],ids:[],bbox:null,parseXML:function(a){var b=null;a.responseXML?b=a.responseXML:window.DOMParser?b=(new DOMParser).parseFromString(a.responseText,"text/xml"):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a.responseText));b=b.firstChild;if("ServiceExceptionReport"==b.nodeName)return a=b.getElementsByTagName("ServiceException")[0],this.serviceExceptionMessage=a.text||a.textContent,!1;if("GetFeatureInfoResponse"==
b.nodeName){this.fields=["feature_id"];a=!0;this.features=[];this.ids=[];var c=b.getElementsByTagName("BoundingBox")[0];c&&(this.bbox={minx:parseFloat(c.getAttribute("minx")),miny:parseFloat(c.getAttribute("miny")),maxx:parseFloat(c.getAttribute("maxx")),maxy:parseFloat(c.getAttribute("maxy"))});b=b.getElementsByTagName("Layer")[0];if(null!=b)for(var b=b.getElementsByTagName("Feature"),d=0;d<b.length;d++){var e=[],c=b[d],f=c.getAttribute("id");e.push(f);this.ids.push(f);for(var f=c.getElementsByTagName("Attribute"),
h=0;h<f.length;h++){var g=f[h];"maptip"!=g.getAttribute("name")&&(a&&this.fields.push(g.getAttribute("name")),e.push(g.getAttribute("value").replace("NULL",Eqwc.settings.noDataValue)))}c=c.getElementsByTagName("BoundingBox");0<c.length&&(c=c[0],a&&this.fields.push("bbox"),e.push({minx:parseFloat(c.getAttribute("minx")),miny:parseFloat(c.getAttribute("miny")),maxx:parseFloat(c.getAttribute("maxx")),maxy:parseFloat(c.getAttribute("maxy"))}));a=!1;this.features.push(e)}return!0}this.serviceExceptionMessage=
"Error";return!1},serviceException:function(){return this.serviceExceptionMessage},featureFields:function(){return this.fields},featuresArray:function(){return this.features},featureIds:function(){return this.ids},featuresBbox:function(){return this.bbox}});
Ext.override(Ext.ToolTip,{show:function(){this.anchor&&(this.showAt([-1E3,-1E3]),this.origConstrainPosition=this.constrainPosition,this.constrainPosition=!1,this.anchor=this.origAnchor);this.showAt(this.getTargetXY());this.anchor?(this.anchorEl.show(),this.syncAnchor(),this.constrainPosition=this.origConstrainPosition):this.anchorEl&&this.anchorEl.hide()},showAt:function(a){this.lastActive=new Date;this.clearTimers();Ext.ToolTip.superclass.showAt.call(this,a);this.dismissDelay&&!1!==this.autoHide&&
(this.dismissTimer=this.hide.defer(this.dismissDelay,this));this.anchor&&!this.anchorEl.isVisible()?(this.syncAnchor(),this.anchorEl.show()):this.anchorEl&&this.anchorEl.hide()}});
QGIS.LayerOrderPanel=Ext.extend(Ext.Panel,{title:null,store:null,grid:null,constructor:function(a){a=a||{};QGIS.LayerOrderPanel.superclass.constructor.call(this,a)},initComponent:function(){this.addEvents("layerVisibilityChange","orderchange","opacitychange");this.store=new Ext.data.ArrayStore({fields:[{name:"layer"}]});var a=this;this.grid=new Ext.grid.GridPanel({store:this.store,columns:[{id:"layer",header:"Ebene",dataIndex:"layer",renderer:function(b,c,d,e,f,h){b=d.get("layer");return b+"<el id='layerOrder_"+
a.escapeString(b)+"'></el>"}},{xtype:"actioncolumn",id:"actions",width:40,align:"right",items:[{iconCls:"action-icon action-down",tooltip:layerOrderPanelLayerSettingsTooltipString[lang],getClass:function(a,c,d){return"layerOptions_"+this.escapeString(d.get("layer"))},handler:function(a,c,d,e){c=this.escapeString(this.store.getAt(c).get("layer"));d=Ext.select("img.layerOptions_"+c).first();d.toggleClass("action-down");d.toggleClass("action-up");Ext.select("#opacitySlider_"+c).first().parent("tr").toggle();
this.resizeOpacitySlider(c,a.getWidth())},scope:this},{iconCls:"action-icon action-visible",tooltip:layerOrderPanelVisibilityChangeTooltipString[lang],getClass:function(a,c,d){return"layerOptions_"+this.escapeString(d.get("layer"))},handler:function(a,c,d){a=this.escapeString(this.store.getAt(c).get("layer"));a=Ext.select("img.layerOptions_"+a).first().next();a.toggleClass("action-visible");a.toggleClass("action-invisible");c=this.store.getAt(c);this.fireEvent("layerVisibilityChange",c.get("layer"))},
scope:this}]}],listeners:{resize:function(b,c,d,e,f){b.doLayout();b=this.getStore().getRange();for(d=0;d<b.length;d++)a.resizeOpacitySlider(a.escapeString(b[d].get("layer")),c)},render:function(b){new Ext.dd.DropTarget(b.container,{ddGroup:"layerorder",copy:!1,notifyDrop:function(c,e,f){var h=b.getStore(),g=b.getSelectionModel(),k=g.getSelections();if(c.getDragData(e)&&(c=c.getDragData(e).rowIndex,void 0!=c)){for(e=0;e<k.length;e++)h.remove(h.getById(k[e].id));h.insert(c,f.selections);g.clearSelections();
a.addOpacitySlider(f.selections[0].get("layer"));a.fireEvent("orderchange")}}});var c=b.getView().dragZone;c.addInvalidHandleClass("x-grid3-col-actions");c.addInvalidHandleClass("x-action-col-icon");c.addInvalidHandleClass("opacity-slider");c.addInvalidHandleClass("x-slider");c.addInvalidHandleClass("x-slider-end");c.addInvalidHandleClass("x-slider-inner");c.addInvalidHandleClass("x-slider-thumb");c.addInvalidHandleClass("x-slider-focus")}},ddGroup:"layerorder",ddText:layerOrderPanelMoveLayerTextString[lang],
enableDragDrop:!0,sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),hideHeaders:!0,autoExpandColumn:"layer",border:!1});Ext.apply(this,{layout:"fit",autoScroll:!0,border:!1,items:[this.grid]});QGIS.LayerOrderPanel.superclass.initComponent.call(this)},addLayer:function(a,b){var c=new this.store.recordType({layer:a},a);this.store.insert(0,c);this.addOpacitySlider(a);-1==visibleLayers.indexOf(a)&&this.toggleLayerVisibility(a)},clearLayers:function(){this.store.removeAll()},hasLayer:function(a){return void 0!=
this.store.getById(a)},toggleLayerVisibility:function(a){this.hasLayer(a)&&(a=this.escapeString(a),a=Ext.select("img.layerOptions_"+a).first().next(),a.toggleClass("action-visible"),a.toggleClass("action-invisible"))},layerVisible:function(a){var b=void 0;this.hasLayer(a)&&(b=this.escapeString(a),a=Ext.select("img.layerOptions_"+b).first().next(),b=!0,a.dom.className.match(/action-invisible/)&&(b=!1));return b},orderedLayers:function(){var a=[];this.store.each(function(b){a.push(b.get("layer"))});
return a.reverse()},addOpacitySlider:function(a){var b=this.escapeString(a),c="opacitySlider_"+b,d=Ext.DomHelper.insertAfter(Ext.select("tr:has(#layerOrder_"+b+")").first(),{tag:"tr",cls:"opacity-slider",children:[{tag:"td",colspan:2,id:c}]},!0);(new Ext.slider.SingleSlider({renderTo:c,id:"opacitySliderCmp_"+b,minValue:0,maxValue:255,value:wmsLoader.layerProperties[a].opacity,plugins:new Ext.slider.Tip({getText:function(a){return String.format(layerOrderPanelTransparencyTooltipString[lang],Math.round((255-
a.value)/255*100))}})})).on("changecomplete",function(b,c,d){this.fireEvent("opacitychange",a,c)},this);d.setVisibilityMode(Ext.Element.DISPLAY);d.hide()},resizeOpacitySlider:function(a,b){var c=Ext.ComponentMgr.get("opacitySliderCmp_"+a);c.getEl().parent("tr").isVisible()&&c.setWidth(b-19)},escapeString:function(a){return a.replace(/[^\w]/g,"_")}});Ext.reg("qgis_layerorderpanel",QGIS.LayerOrderPanel);
QGIS.LocationService=Ext.extend(Ext.util.Observable,{constructor:function(a){this.location=a.location;this.language=a.language;this.addEvents(["elevation","address"]);this.listeners=a.listeners;QGIS.LocationService.superclass.constructor.call(this,a)},locationToString:function(){return this.location.lon.toFixed(coordinatePrecision)+", "+this.location.lat.toFixed(coordinatePrecision)},locationToWgs:function(){return this.location.clone().transform(authid,new OpenLayers.Projection("EPSG:4326"))},getService:function(a){var b,
c,d,e,f,h,g;switch(a.name){case "elevation":switch(a.provider.toLowerCase()){case "mapbox":b="https://api.mapbox.com/v4/surface/mapbox.mapbox-terrain-v1.json";c="results";d="ele";e="<tr><td>{ele}m "+TR.fiElevation+"</td></tr>";f={layer:"contour",fields:"ele",points:this.locationToWgs().toShortString(),access_token:a.key};break;case "mapzen":b="https://elevation.mapzen.com/height",c="",d="height",e="<tr><td>{height}m "+TR.fiElevation+"</td></tr>",f={json:Ext.util.JSON.encode({range:!1,shape:[{lat:this.locationToWgs().lat,
lon:this.locationToWgs().lon}]}),api_key:a.key}}break;case "address":switch(a.provider.toLowerCase()){case "mapzen":b="https://search.mapzen.com/v1/reverse";c="features";d="properties";e="<tr><td>{label}  ("+measureDistanceResultPrefixString[lang].toLowerCase()+" {distance}m)</td></tr>";h="<tr><td>{region}, {country}</td></tr>";g=1E3;f={layers:"address","point.lat":this.locationToWgs().lat,"point.lon":this.locationToWgs().lon,api_key:a.key,size:1};break;case "mapbox":b="https://api.mapbox.com/geocoding/v5/mapbox.places/"+
this.locationToWgs().lon+","+this.locationToWgs().lat+".json",c="features",d="",e="<tr><td>{place_name}</td></tr>",h="",g=1,f={access_token:a.key,types:"address,neighborhood,place",language:this.language}}}Ext.Ajax.request({url:b,params:f,method:"GET",scope:this,success:function(b){b=Ext.util.JSON.decode(b.responseText);0<b[c].length&&this.fireEvent(a.name,b[c][0],this.locationToString(),d,e,h,g)},failure:function(a){}})}});Ext.reg("qgis_location",QGIS.LocationService);
Ext.override(Ext.dd.DragTracker,{onMouseMove:function(a,b){var c=Ext.isIE6||Ext.isIE7||Ext.isIE8;if(this.active&&c&&!a.browserEvent.button)a.preventDefault(),this.onMouseUp(a);else{a.preventDefault();var c=a.getXY(),d=this.startXY;this.lastXY=c;if(!this.active)if(Math.abs(d[0]-c[0])>this.tolerance||Math.abs(d[1]-c[1])>this.tolerance)this.triggerStart(a);else return;this.fireEvent("mousemove",this,a);this.onDrag(a);this.fireEvent("drag",this,a)}}});Ext.namespace("GeoExt.ux");
GeoExt.ux.GeocodingSearchCombo=Ext.extend(Ext.form.ComboBox,{map:null,highlightLayerName:null,highlightLayer:null,width:350,listWidth:350,zoom:8,minChars:1,queryDelay:50,maxRows:"20",tpl:'<tpl for="."><div class="x-combo-list-item">{'+this.displayField+"}</div></tpl>",countryString:"",sources:"",layers:"",hideTrigger:!1,displayField:"name",forceSelection:!0,queryParam:"text",url:"https://search.mapzen.com/v1/search?",initComponent:function(){this.triggerConfig={tag:"img",src:Ext.BLANK_IMAGE_URL,cls:"x-form-trigger x-form-clear-trigger"};
this.on("keyUp",this.keyUpHandler);this.on("afterrender",this.afterrenderHandler);this.on("beforeselect",this.beforeselectHandler);GeoExt.ux.GeocodingSearchCombo.superclass.initComponent.apply(this,arguments);this.highlightLayerName&&(this.highlightLayer=this.map.getLayersByName(this.highlightLayerName)[0]);var a={size:this.maxRows,layers:this.layers,api_key:this.key};"undefined"!==typeof this.countryString&&(a["boundary.country"]=this.countryString);"undefined"!==typeof this.sources&&(a.sources=
this.sources);this.store=new Ext.data.Store({proxy:new Ext.data.ScriptTagProxy({url:this.url,method:"GET",nocache:!1,autoAbort:!0}),baseParams:a,reader:new Ext.data.JsonReader({idProperty:"properties.id",root:"features",fields:[{name:"id",mapping:"properties.id"},{name:"confidence",mapping:"properties.confidence"},{name:"country",mapping:"properties.country"},{name:"region",mapping:"properties.region"},{name:"locality",mapping:"properties.locality"},{name:"street",mapping:"properties.street"},{name:"housenumber",
mapping:"properties.housenumber"},{name:"postalcode",mapping:"properties.postalcode"},{name:"label",mapping:"properties.label"},{name:"lng",mapping:"geometry.coordinates[0]"},{name:"lat",mapping:"geometry.coordinates[1]"},{name:"name",mapping:"properties.name"},{name:"name2",convert:this.getName2}]})});if(0<this.zoom)this.on("select",function(a,c,d){a=new OpenLayers.LonLat(c.data.lng,c.data.lat);a.transform(new OpenLayers.Projection("EPSG:4326"),this.map.getProjectionObject());c=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.lon,
a.lat),{},Eqwc.settings.symbolizersHighLightLayer.Point);this.highlightLayer.removeAllFeatures();this.highlightLayer.addFeatures(c);this.map.setCenter(a,this.zoom)},this)},getName2:function(a,b){return b.properties.street+" "+b.properties.housenumber},afterrenderHandler:function(){this.trigger.hide()},beforeselectHandler:function(a,b,c){"1"==b.get("selectable")&&this.collapse()},keyUpHandler:function(a,b){this.checkTrigger();Ext.isEmpty(this.getValue())&&this.resetSearch();this.getValue().length<
this.minChars&&this.collapse()},checkTrigger:function(){if(this.rendered)this.trigger[Ext.isEmpty(this.getValue())?"hide":"show"]()},onTriggerClick:function(){this.resetSearch();this.checkTrigger();this.focus()},resetSearch:function(){this.collapse();this.clearSearchResult()},clearSearchResult:function(){this.setValue("");this.highlightLayer&&this.highlightLayer.removeAllFeatures()}});Ext.reg("gxux_GeocodingSearchCombo",GeoExt.ux.GeocodingSearchCombo);function showFeatureInfo(a){removeClickPopup();hoverPopup&&removeHoverPopup();if(identifyToolActive){var b=geoExtMap.map;window.DOMParser?xmlDoc=(new DOMParser).parseFromString(a.text,"text/xml"):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(a.text));var c="",d="<h2>"+TR.fiLocation+"</h2>";a=b.getLonLatFromPixel(a.xy);var e=new QGIS.LocationService({location:a,language:projectData.lang}),f=[];Eqwc.settings.showCoordinatesIdentify&&(c="</br>",f.push({xtype:"box",
html:d},{id:"fi_location",xtype:"box",html:"<tr><td>"+e.locationToString()+"</td></tr>"}));if(null!=projectData.locationServices)for(c="</br>",d=0;d<projectData.locationServices.length;d++)e.getService({name:projectData.locationServices[d].name,key:projectData.locationServices[d].key,provider:projectData.locationServices[d].provider}),f.push({id:"fi_"+projectData.locationServices[d].name,xtype:"box",html:"</br>"});e.on("elevation",updateElevation);e.on("address",updateAddress);featureInfoResultLayers=
[];highLightGeometry=[];parseFIResult(xmlDoc);featureInfoResultLayers.reverse();if(0<featureInfoResultLayers.length){if("topMostHit"==identificationMode)c+=featureInfoResultLayers[0];else for(d=0;d<featureInfoResultLayers.length;d++)c+=featureInfoResultLayers[d];f.push({id:"fi_qgis",xtype:"box",html:c})}clickPopup=new GeoExt.Popup({title:clickPopupTitleString[lang],location:a,map:b,autoScroll:!0,bodyStyle:"padding:5px",items:f,maximizable:!0,collapsible:!0,listeners:{close:onClickPopupClosed,beforeshow:function(){var a=
0.8*geoExtMap.getHeight();280<0.25*geoExtMap.getWidth()?this.setWidth(0.25*geoExtMap.getWidth()):this.setWidth(280);this.getHeight()>a&&this.setHeight(a)}}});0<f.length&&clickPopup.show();changeCursorInMap("default")}activateGetFeatureInfo(!0)}
function showFeatureInfoHover(a){var b=geoExtMap.map;if(identifyToolActive){hoverPopup&&removeHoverPopup();window.DOMParser?xmlDoc=(new DOMParser).parseFromString(a.text,"text/xml"):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(a.text));var c=xmlDoc.getElementsByTagName("Layer"),d="",e=!1,f=showFeatureInfoLayerTitle;mapThemeSwitcher&&void 0!=mapThemeSwitcher.activeProjectData&&(f=mapThemeSwitcher.activeProjectData.showFeatureInfoLayerTitle);for(var h=c.length-1;-1<
h;--h){for(var g=c[h].getElementsByTagName("Feature"),k=wmsLoader.layerProperties[c[h].getAttribute("name")].displayField||"tooltip",n=0;n<g.length;++n){0==n&&(f&&(d+='<h2 class="hoverLayerTitle">'+wmsLoader.layerProperties[c[h].getAttribute("name")].title+"</h2>"),e=!0);for(var l=g[n].getElementsByTagName("Attribute"),p={},q=0;q<l.length;++q)p[l[q].getAttribute("name")]=l[q].getAttribute("value");q=p.hasOwnProperty(k);l=p.hasOwnProperty("geometry");if(q)q=p[k],q.match(/</)?d+=q:(attribText="<p>"+
q.replace(/\n/,"<br/>"),attribText=attribText.replace("\n","<br/>"),d+=attribText+"</p>"),d+='<hr class="hrHoverLayer"/>';else if(tooltipTemplates&&tooltipTemplates.hasOwnProperty(c[h].getAttribute("name")))templateText=tooltipTemplates[c[h].getAttribute("name")].template,q=templateText.replace(/<%(\w*)%>/g,function(a,b){return(p.hasOwnProperty(b)?p[b]:"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),d+=q+"<br/>";else if(-1!==k.indexOf("[%")){for(var q=
k,u=RegExp(/\[%[^"]*"(.*?)"[^"]*%\]/g),m;m=u.exec(k);)var r=m[1],r=p.hasOwnProperty(r)?p[r]:"",q=q.replace(m[0],r);d+=q+"<br/>"}l&&(l=new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(p.geometry)),featureInfoHighlightLayer.addFeatures([l]))}g=[];for(n=c[h].firstChild;n;)"Attribute"==n.nodeName&&g.push(n),n=n.nextSibling;for(n=0;n<g.length;++n)0==n&&(f&&(d+='<h2 class="hoverLayerTitle">'+wmsLoader.layerProperties[c[h].getAttribute("name")].title+"</h2>"),e=!0),d+="<p>"+g[n].getAttribute("name")+
": "+g[n].getAttribute("value")+"</p>",d+='<hr class="hrHoverLayer"/>';if("topMostHit"==identificationMode&&e)break}e?(changeCursorInMap("pointer"),clickPopup||(d=d.replace(/<hr class="hrHoverLayer"\/>$/,""),hoverPopup=new OpenLayers.Popup.FramedCloud(null,b.getLonLatFromPixel(a.xy),null,d,null,!1,null),hoverPopup.autoSize=!0,hoverPopup.keepInMap=!0,hoverPopup.panMapIfOutOfView=!1,hoverPopup.events.on({click:onHoverPopupClick}),b.addPopup(hoverPopup))):changeCursorInMap("default")}}
function onBeforeGetFeatureInfoClick(a){a.object.layers[0].setVisibility(thematicLayer.getVisibility());activateGetFeatureInfo(!1)}function noFeatureInfoClick(a){activateGetFeatureInfo(!0)}function onHoverPopupClick(a){hoverPopup&&removeHoverPopup();var b=geoExtMap.map;a.xy=b.events.getMousePosition(a);b.events.triggerEvent("click",a)}
function onClickPopupClosed(a){removeClickPopup();Eqwc.settings.enableHoverPopup&&WMSGetFInfoHover.activate();var b=geoExtMap.map;a.xy=b.events.getMousePosition(a);b.events.triggerEvent("mousemove",a)}function removeClickPopup(){clickPopup&&clickPopup.destroy();clickPopup=null}function removeHoverPopup(){geoExtMap.map.removePopup(hoverPopup);hoverPopup.destroy();hoverPopup=null;featureInfoHighlightLayer.removeAllFeatures()}
function showFeatureSelected(a){null==a.layer&&a.fid.split(".");featureInfoHighlightLayer.removeAllFeatures();featureInfoHighlightLayer.addFeatures([a]);geoExtMap.map.zoomToExtent(a.geometry.bounds)}function clearFeatureSelected(){void 0!=thematicLayer.params.SELECTION&&thematicLayer.mergeNewParams({SELECTION:null});featureInfoHighlightLayer.removeAllFeatures()}
function parseFIResult(a){if(a.hasChildNodes()){var b=showFeatureInfoLayerTitle;mapThemeSwitcher&&void 0!=mapThemeSwitcher.activeProjectData&&(b=mapThemeSwitcher.activeProjectData.showFeatureInfoLayerTitle);if(a.hasChildNodes()&&"Layer"==a.nodeName){var c=!1,d=!1,e="",f=a.firstChild,h=a.getAttribute("name"),h=wmsLoader.layerProperties[h].title;b&&(e+="<h2>"+h+"</h2>");for(b=h+"."+a.firstElementChild.getAttribute("id");f;){if(f.hasChildNodes()&&"Feature"===f.nodeName){var g=f.firstChild,e=e+"<table><tbody>",
k=projectData.use_ids?projectData.layers[a.getAttribute("name")].wfs||projectData.add_geom:!1;"guest"==projectData.user&&(k=!1);if(k){var k='<a class="i-select" href="javascript:;" onclick="identifyAction(\'select\',\''+b+"');\"></a>",n="";void 0!==Eqwc.plugins.editing&&(n='<a class="i-edit" href="javascript:;" onclick="identifyAction(\'edit\',\''+b+"');\"></a>");e+="<tr><td colspan='2'>"+k+n+'<a class="i-clear" href="javascript:;" onclick="identifyAction(\'clear\',\'\');"></a></td></tr>'}for(;g;){if("Attribute"==
g.nodeName&&(k=g.getAttribute("name"),n=g.getAttribute("value").replace("NULL",Eqwc.settings.noDataValue),k!==mapInfoFieldName&&(!0==suppressEmptyValues&&""!==n.replace(/^\s\s*/,"").replace(/\s\s*$/,"")||!1==suppressEmptyValues)))if("geometry"===k){var l=new OpenLayers.Feature.Vector(OpenLayers.Geometry.fromWKT(n));l.fid=b;highLightGeometry.push(l);suppressInfoGeometry||(e+="\n   <tr>",showFieldNamesInClickPopup&&(e+="<td>"+k+":</td>"),e+="<td>"+n+"</td></tr>",c=!0)}else c=Eqwc.settings.qgisFilesFieldAlias?
Eqwc.settings.qgisFilesFieldAlias:"files",e+="\n   <tr>",showFieldNamesInClickPopup&&"maptip"!==k&&k!==c&&(e+="<td>"+k+":</td>"),k==c?""<n&&(n=Ext.util.JSON.decode(n),l=[],Ext.each(n,function(a,b,c){this.push(Eqwc.common.manageFile(a,!0))},l),n=l.join("</br>")):n=Eqwc.common.createHyperlink(n,null,mediaurl),e="maptip"==k||k==c?e+("<td colspan='2'>"+n+"</td></tr>"):e+("<td>"+n+"</td></tr>"),c=!0;g=g.nextSibling}e+="\n  </tbody>\n </table></br>"}else"Attribute"===f.nodeName&&(!1==d&&(e+="\n <p></p>\n <table>\n  <tbody>"),
e+="\n<tr><td>"+Eqwc.common.getRasterFieldName(h,f.getAttribute("name"))+"</td><td>"+f.getAttribute("value")+"</td></tr>",d=c=!0);f=f.nextSibling}c&&(d&&(e+="\n  </tbody>\n </table></br>"),featureInfoResultLayers.push(e))}else for(a=a.firstChild;a;)parseFIResult(a),a=a.nextSibling}}function listLayersWithFeatures(a){if(a.hasChildNodes())if("Layer"==a.nodeName)featureInfoResultLayers.push(a.getAttribute("name"));else for(a=a.firstChild;a;)listLayersWithFeatures(a),a=a.nextSibling}
function getFeatures(a,b){if(b.hasChildNodes()){if("Layer"==b.nodeName&&b.getAttribute("name")==a)return b.firstChild;for(var c=b.firstChild;c;)getFeatures(a,c),c=c.nextSibling}}function updateElevation(a,b,c,d){b=Ext.getCmp("fi_elevation");void 0!=b&&(d=new Ext.Template(d),void 0===a||isNaN(a[c])||null===a[c]||(a[c]!==parseInt(a[c])&&(a[c]=a[c].toFixed(elevationPrecision)),a=d.apply(a),b.update(a)))}
function updateAddress(a,b,c,d,e,f){b=Ext.getCmp("fi_address");if(void 0!=b){var h=0;a=""==c||null==c?a:a[c];null!=a.distance&&(h=a.distance,a.distance=h*f);tem=h*f>minimumAddressRange?new Ext.Template(e):new Ext.Template(d);d=tem.apply(a);b.update(d)}}
function identifyAction(a,b){var c=b.split(".")[0];if("undefined"!=b.split(".")[1]){var d=wmsLoader.layerTitleNameMapping[c];switch(a){case "clear":clearFeatureSelected();break;case "edit":checkEditorState(d)&&prepareEdit(projectData.layers[d])&&editor.attributesForm.requestAndLoadFeature(b);break;case "select":var e=!1;Ext.each(highLightGeometry,function(a,b,c){a.fid===this[1]&&(showFeatureSelected(a),e=!0)},arguments);e||(d=new OpenLayers.Filter.FeatureId({fids:[b]}),(new OpenLayers.Protocol.WFS({version:"1.0.0",
url:wmsURI,headers:{"Content-Type":"text/xml; charset=utf-8"},featureType:c,geometryName:"geometry",filter:d})).read({maxFeatures:1,callback:function(a){if(200==a.priv.status){if(1==a.features.length){a=a.features[0];var b=a.fid.split(".")[0];a.geometry.transform(projectData.layers[wmsLoader.layerTitleNameMapping[b]].crs,projectData.crs);highLightGeometry.push(a);showFeatureSelected(a)}}else Ext.Msg.alert("Get feature error",a.priv.status+" "+a.priv.statusText+"</br></br>"+a.priv.responseText)},scope:this}))}}}
;function showLegendAndMetadata(a){var b=wmsLoader.layerTitleNameMapping[a];void 0==legendMetadataWindow&&setupLegendAndMetadataWindow();legendMetadataWindow.setTitle(legendMetadataWindowTitleString[lang]+' "'+a+'"');!1==legendMetadataWindow_active&&legendMetadataWindow.show();var c=projectData.layers[b],d={};c&&(d=wmsURI+Ext.urlEncode({SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetLegendGraphics",FORMAT:"image/png",EXCEPTIONS:"application/vnd.ogc.se_inimage",BOXSPACE:1,LAYERSPACE:2,SYMBOLSPACE:1,SYMBOLHEIGHT:2,
LAYERFONTSIZE:8,ITEMFONTSIZE:8,LAYERS:b,DPI:screenDpi}),legendMetaTabPanel=Ext.getCmp("legendMetaTabPanel"),legendMetaTabPanel.activate(legendTab),legendTab.update('<img src="'+d+'" />'),d=c.geom_type,""!=d||"ogr"!=c.provider&&"spatialite"!=c.provider||(d="vector"),""!=d||"gdal"!=c.provider&&"wms"!=c.provider||(d="raster"),d={TYPE:d,PROVIDER:c.provider,CRS:c.crs,IDENTIFY:wmsLoader.layerProperties[b].queryable,EDITABLE:c.wfs,ID:c.id});legendMetaTabPanel.activate(metadataTab);a='<style type="text/css">.even { background-color:rgb(240,240,240);border:none;} .mdCell {padding:0.3em;border:none;} .mdHeader {padding:0.3em;font-weight:bold;border:none;}</style>'+
('<div style="margin:1em;"><h1 style="margin-bottom:0.8em;">'+metadataSectionTitleString[lang]+' "'+a+'"</h1>');wmsLoader.layerProperties[b]["abstract"]&&(a+="<p><b>"+abstractString[lang]+"</b><p><p>"+wmsLoader.layerProperties[b]["abstract"]+"</p>");a+='<p style="margin-top:1em;margin-bottom:0.4em;font-weight:bold;">'+geographicExtentString[lang]+"</p><ul>";a+='<table style="margin-top:0.5em;border:none;border-collapse:collapse;"><tr class="even"><th class="mdHeader">'+westString[lang]+'</th><th class="mdHeader">'+
southString[lang]+'</th><th class="mdHeader">'+eastString[lang]+'</th><th class="mdHeader">'+northString[lang]+"</th></tr>";a+='<tr><td class="mdCell">'+wmsLoader.layerProperties[b].bbox[0]+'</td><td class="mdCell">'+wmsLoader.layerProperties[b].bbox[1]+'</td><td class="mdCell">'+wmsLoader.layerProperties[b].bbox[2]+'</td><td class="mdCell">'+wmsLoader.layerProperties[b].bbox[3]+"</td></tr>";a+="</table>";if(wmsLoader.layerProperties[b].attributes){a+='<p style="margin-top:1em"><b>'+attributesString[lang]+
'</b></p><table style="margin-top:0.5em;border:none;border-collapse:collapse;"><tr class="even"><th class="mdHeader">'+attributeNameString[lang]+'</th><th class="mdHeader">'+attributeTypeString[lang]+'</th><th class="mdHeader">'+attributeCommentString[lang]+'</th><th class="mdHeader">'+attributeLengthString[lang]+'</th><th class="mdHeader">'+attributePrecisionString[lang]+"</th></tr>";for(var c=1,e=0;e<wmsLoader.layerProperties[b].attributes.length;e++)attribute=wmsLoader.layerProperties[b].attributes[e],
a=0==c%2?a+'<tr class="even">':a+"<tr>",a+='<td class="mdCell">'+attribute.name+'</td><td class="mdCell">'+attribute.type+'</td><td class="mdCell">'+attribute.comment+'</td><td class="mdCell">'+attribute.length+'</td><td class="mdCell">'+attribute.precision+"</td></tr>",c++;a+="</table>"}a+="</div>";metadataTab.getComponent("propertyText").update(a);metadataTab.getComponent("propertyGrid").setSource(d);showMetaDataInLegend||legendMetaTabPanel.remove("metadataTab",!0)}
function setupLegendAndMetadataWindow(){legendMetadataWindow=new Ext.Window({title:legendMetadataWindowTitleString[lang],width:400,height:300,autoScroll:!0,maximizable:!0,layout:"fit",shadow:!1,items:[{xtype:"tabpanel",activeTab:0,defaults:{autoScroll:!0},id:"legendMetaTabPanel",items:[{title:metadataTabTitleString[lang],id:"metadataTab",items:[new Ext.grid.PropertyGrid({itemId:"propertyGrid",autoHeight:!0,stripeRows:!1,hideHeaders:!0,viewConfig:{forceFit:!0,scrollOffset:2,templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}" tabIndex="0" {cellAttr}>',
'<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},listeners:{beforeedit:function(a){return!1}}}),new Ext.Container({itemId:"propertyText"})]},{title:legendTabTitleString[lang],id:"legendTab"}]}],listeners:{show:function(){legendMetadataWindow_active=!0},hide:function(){legendMetadataWindow_active=!1},close:function(){legendMetadataWindow=void 0}}});legendMetaTabPanel=Ext.getCmp("legendMetaTabPanel");legendTab=Ext.getCmp("legendTab");metadataTab=Ext.getCmp("metadataTab")}
;function buildGroupContextMenu(a){var b=[];b.push({text:contextZoomLayerExtent[lang],iconCls:"x-zoom-icon",handler:zoomToLayerExtent});b.push({text:TR.properties,handler:layerProperties});a.menu=new Ext.menu.Menu({items:b})}
function buildLayerContextMenu(a){var b=wmsLoader.layerTitleNameMapping[a.attributes.text],c=wmsLoader.layerProperties[b],b=projectData.layers[b],d=[];d.push({text:contextZoomLayerExtent[lang],iconCls:"x-zoom-icon",handler:zoomToLayerExtent});c.queryable&&"undefined"!==typeof c.attributes&&d.push({text:contextOpenTable[lang],iconCls:"x-table-icon",handler:openAttTable});void 0!=b&&"gdal"!==b.provider&&"wms"!==b.provider&&d.push({itemId:"contextExport",text:contextDataExport[lang],iconCls:"x-export-icon",
menu:[{itemId:"SHP",text:"ESRI Shapefile",handler:exportHandler},{itemId:"DXF",text:"AutoCAD DXF",handler:exportHandler},{itemId:"XLSX",text:"MS Office Open XLSX",handler:exportHandler},{itemId:"CSV",text:"Text CSV",handler:exportHandler},{itemId:"KML",text:"Keyhole Markup Language KML",handler:exportHandler},{itemId:"GeoJSON",text:"GeoJSON",handler:exportHandler},"-",{itemId:"currentExtent",text:contextUseExtent[lang],checked:!0,hideOnClick:!1}]});d.push({text:TR.properties,handler:layerProperties});
a.menu=new Ext.menu.Menu({items:d});a.filter=[]}function zoomToLayerExtent(a){a=layerTree.getSelectionModel().getSelectedNode().text;a=(new OpenLayers.Bounds(wmsLoader.layerProperties[wmsLoader.layerTitleNameMapping[a]].bbox)).transform("EPSG:4326",geoExtMap.map.projection);geoExtMap.map.zoomToExtent(a)}function exportHandler(a){var b=layerTree.getSelectionModel().getSelectedNode().text,c=a.container.menuItemId;a=a.ownerCt.getComponent("currentExtent");exportData(b,c,a.checked)}
function layerProperties(a){a=layerTree.getSelectionModel().getSelectedNode().text;showLegendAndMetadata(a)}function contextMenuHandler(a){var b=a.menu.getComponent("contextExport");void 0!=b&&("guest"==projectData.user?b.setDisabled(!0):b.setDisabled(!1));a.select();a.menu.show(a.ui.getAnchor())}
function zoomHandler(a,b,c,d,e){c=a.getStore().getAt(b);d=c.id;e=a.itemId;a.getSelectionModel().selectRow(b);c.data.layer=e;c.data.doZoomToExtent=!0;c.data.id=d;a=c.data.bbox;c.data.bbox instanceof OpenLayers.Bounds||(c.data.bbox=OpenLayers.Bounds.fromArray([a.minx,a.miny,a.maxx,a.maxy]));showRecordSelected(c.data)}
function showRecordSelected(a){var b=null==a.layer?a.fid.split(".")[0]:a.layer;thematicLayer.mergeNewParams({SELECTION:wmsLoader.layerTitleNameMapping[b]+":"+a.id});a.doZoomToExtent?geoExtMap.map.zoomToExtent(a.bbox):geoExtMap.map.setCenter(new OpenLayers.LonLat(a.x,a.y),a.zoom)}
function exportData(a,b,c){var d=wmsLoader.layerTitleNameMapping[a],e=projectData.layers[d].crs,d=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d][b]);return c.join(",")}(wmsLoader.layerProperties[d].attributes,"name"),f=null,h=null;c&&(f=geoExtMap.map.calculateBounds(),h=geoExtMap.map.calculateBounds().transform(authid,e));var g="./admin/export.php?"+Ext.urlEncode({map:projectData.project,SRS:authid,map0_extent:f,layer_extent:h,layer:a,fields:d,format:b});Ext.Ajax.request({url:g,disableCaching:!1,
params:{cmd:"prepare"},method:"GET",success:function(a){a=Ext.util.JSON.decode(a.responseText);a.success?(a=a.message,Ext.getBody().createChild({tag:"iframe",cls:"x-hidden",id:"hiddenform-iframe",name:"iframe",src:g+"&cmd=get&key="+a})):Ext.Msg.alert("Error",a.message)},failure:function(a,b){Ext.Msg.alert("Error","server-side failure with status code "+a.status)}})}
function openAttTable(){var a=layerTree.getSelectionModel().getSelectedNode().text,b=wmsLoader.layerTitleNameMapping[a],b=projectData.use_ids?projectData.layers[b].wfs:!1,c=null,d=null;(d=this.parentMenu.getComponent("mapFilter"))&&(c=d.getFilter());var d=Ext.getCmp("BottomPanel"),e=Ext.getCmp("table_"+a);void 0==e?(d=new QGIS.SearchPanel({useWmsRequest:!0,wmsFilter:c,queryLayer:a,gridColumns:getLayerAttributes(a).columns,gridLocation:"bottom",gridEditable:b,gridTitle:a,gridResults:Eqwc.settings.limitAttributeFeatures,
gridResultsPageSize:20,selectionLayer:a,formItems:[],doZoomToExtent:!0}),d.onSubmit(),d.on("featureselectioncleared",clearFeatureSelected),d.on("beforesearchdataloaded",showSearchPanelResults)):(d.activate(e),d.show(),d.collapsible&&d.expand())}function clearTableSelection(){this.ownerCt.ownerCt.getSelectionModel().clearSelections();clearFeatureSelected()}function loadMore(){this.gridResults*=2;this.onSubmit()}
function applyWMSFilter(a){a=a.itemId.split("_")[1]-1;var b=layerTree.getSelectionModel().getSelectedNode();thematicLayer.params.FILTER=b.text+":"+b.filter[a].value;thematicLayer.redraw()}
function getLayerAttributes(a){var b=wmsLoader.layerTitleNameMapping[a];a={columns:[]};for(var c=0;c<wmsLoader.layerProperties[b].attributes.length;c++){a.columns[c]={};var d=wmsLoader.layerProperties[b].attributes[c],e=d.type;"CheckBox"==d.editType&&(e="boolean");"QDateTime"==e&&(e="date");a.columns[c].header=null==d.alias?d.name:d.alias;a.columns[c].dataIndex=d.name;a.columns[c].menuDisabled=!1;a.columns[c].sortable=!0;a.columns[c].filterable=!0;a.columns[c].renderer=function(a){if("files"==this.dataIndex){if(""<
a){a=Ext.util.JSON.decode(a);var b=[];Ext.each(a,function(a,b,c){this.push(Eqwc.common.manageFile(a,!1))},b);a=b.join(", ")}return a}return Eqwc.common.createHyperlink(a,null,mediaurl)};"double"==e&&(a.columns[c].xtype="numbercolumn",a.columns[c].format="0.000,00/i",a.columns[c].align="right");"int"==e&&(a.columns[c].xtype="numbercolumn",a.columns[c].format="000",a.columns[c].align="right");"date"==e&&(a.columns[c].xtype="datecolumn",a.columns[c].format="Y-m-d H:i:s")}b=getActionColumns(b);null!=
b&&a.columns.unshift(b);a.columns.unshift(new Ext.ux.grid.RowNumberer({width:32}));return a}function getActionColumns(a){return new Ext.grid.ActionColumn({width:22,items:[{icon:iconDirectory+"contextmenu/zoom.png",tooltip:TR.show,disabled:!1,handler:zoomHandler}]})};function loadWMSConfig(a){loadMask=new Ext.LoadMask(Ext.getCmp("MapPanel").body,{msg:mapLoadingString[lang]});loadMask.show();wmsLoader=new QGIS.WMSCapabilitiesLoader({url:wmsURI,useGetProjectSettings:useGetProjectSettings,layerOptions:{buffer:0,singleTile:!0,ratio:1},layerParams:{TRANSPARENT:"TRUE"},projectSettings:null,initialVisibleLayers:[],createNode:function(a){a.checked=!1;a.hidden=a.text==Eqwc.settings.QgisUsersPrintName;var c=projectData.baseLayers();null!==c&&Ext.each(c,function(a,b,c){if(a.title==
this.text)return this.hidden=!0,this.layer.metadata.visible=!1},a);a.layer.metadata.showCheckbox||(a.cls="layer-checkbox-hidden");return QGIS.WMSCapabilitiesLoader.prototype.createNode.apply(this,[a])},baseAttrs:{uiProvider:Ext.tree.TriStateNodeUI},topicName:a,listeners:{loadexception:function(a,c,d){exceptionLoading(d)}}});a=new Ext.tree.AsyncTreeNode({id:"wmsNode",text:"WMS",loader:wmsLoader,allowDrop:!1,expanded:!0,expandChildNodes:!0,listeners:{load:function(){postLoading()}}});layerTree.setRootNode(a)}
function postLoading(){function a(a){var b=wmsLoader.projectSettings.capability.layerDrawingOrder;null!=layerOrderPanel&&(b=layerOrderPanel.orderedLayers());if(null!=b){for(var c=[],d=0;d<b.length;d++){var e=b[d];-1!=a.indexOf(e)&&c.push(e)}return c}return a.reverse()}function b(a){for(var b=[],c=0;c<a.length;c++)b.push(wmsLoader.layerProperties[a[c]].opacity);return b}var c=Ext.getCmp("DescriptionPanel");15<c.el.dom.innerText.length&&c.setVisible(!0);var d=function(a,c){var d=wmsLoader.layerTitleNameMapping[a.text];
if(a.isLeaf()&&d)if(c)selectedLayers.push(d),wmsLoader.layerProperties[d].queryable&&selectedQueryableLayers.push(d);else{var e=selectedLayers.indexOf(d);-1<e&&selectedLayers.splice(e,1);d=selectedQueryableLayers.indexOf(d);-1<d&&selectedQueryableLayers.splice(d,1)}customActionLayerTreeCheck(a);format=imageFormatForLayers(selectedLayers);if("activeLayers"==identificationMode){var f=[],g=[];a.cascade(function(a){a.isLeaf()&&a.attributes.checked&&(a=wmsLoader.layerTitleNameMapping[a.text],void 0!=a&&
(f.push(a),wmsLoader.layerProperties[a].queryable&&g.push(a)))})}0==selectedQueryableLayers.length?thematicLayer.setVisibility(!1):thematicLayer.setVisibility(!0);thematicLayer.mergeNewParams({LAYERS:selectedLayers.join(","),OPACITIES:b(selectedLayers),FORMAT:format});"activeLayers"!=identificationMode?(WMSGetFInfo.vendorParams={QUERY_LAYERS:selectedQueryableLayers.join(",")},Eqwc.settings.enableHoverPopup&&(WMSGetFInfoHover.vendorParams={QUERY_LAYERS:selectedQueryableLayers.join(",")})):(WMSGetFInfo.vendorParams=
{QUERY_LAYERS:g.join(",")},Eqwc.settings.enableHoverPopup&&(WMSGetFInfoHover.vendorParams={QUERY_LAYERS:g.join(",")}))},e=function(a,b){if(enableBGMaps&&0<f.length){var c=b?a.layer.name:null;layerTree.root.lastChild.cascade(function(b){b.isLeaf()&&b.attributes.checked&&b.layer.name!=a.layer.name&&(b.unselect(!0),b.removeListener("checkchange",e),b.layer.setVisibility(!1),b.addListener("checkchange",e))});currentlyVisibleBaseLayer=c}},c=Eqwc.settings.visibleFirstBaseLayer?0:-1,f=projectData.setBaseLayers(!0),
h=projectData.setBaseLayers(!1),g=makeLayer(projectData.overViewLayer(),!0);customBeforeMapInit();layerTree.selectPath(layerTree.root.firstChild.getPath());applyPermalinkParams();layerTree.suspendEvents();if(layerTree.root.hasChildNodes()){document.title=titleBarText;if(""<headerLogoLink){Ext.select("#panel_header_link a").replaceWith({tag:"a",href:headerLogoLink,target:"_blank",children:[{tag:"img",src:headerLogoImg,height:headerLogoHeight}]});Ext.get("panel_header_title").setStyle("padding-left",
"8px");var k=(headerLogoHeight-18)/2;Ext.get("panel_header_title").setStyle("padding-top",k+"px")}Ext.get("panel_header_title").update(document.title);k=(headerLogoHeight-12)/2;Ext.get("panel_header_user").setStyle("padding-top",k+"px");null==headerTermsOfUseText||Eqwc.settings.useGisPortal||(Ext.select("#panel_header_terms_of_use a").replaceWith({tag:"a",href:headerTermsOfUseLink,cls:"x-tool","ext:qtip":headerTermsOfUseText,target:"_self"}),null!=headerLogoImg&&Ext.get("panel_header_terms_of_use").setStyle("padding-top",
k+"px"));null==visibleLayers&&(visibleLayers=a(wmsLoader.initialVisibleLayers));layerTree.root.firstChild.expand(!0,!1);layerTree.root.findChildBy(function(){this.isExpandable()&&this.expand(!0,!1);return!1},null,!0);for(var n=0;n<visibleLayers.length;n++)layerTree.root.findChildBy(function(){wmsLoader.layerTitleNameMapping[this.attributes.text]==visibleLayers[n]&&this.getUI().toggleCheck(!0);return!1},null,!0);getVisibleFlatLayers(layerTree.root.firstChild);addAbstractToLayerGroups();layerTree.root.firstChild.collapseChildNodes(!0);
layerTree.root.firstChild.expand(!1,!1)}layerTree.checkedLeafs=[];layerTree.resumeEvents();initialLoadDone||(Ext.getCmp("IdentifyTool").toggleHandler=mapToolbarHandler,Ext.getCmp("measureDistance").toggleHandler=mapToolbarHandler,Ext.getCmp("measureArea").toggleHandler=mapToolbarHandler,Ext.getCmp("PrintMap").toggleHandler=mapToolbarHandler,"undefined"==typeof enablePermalink&&(enablePermalink=!0),enablePermalink?Ext.getCmp("SendPermalink").handler=mapToolbarHandler:Ext.getCmp("SendPermalink").destroy(),
customToolbarLoad(),k=Ext.getCmp("ObjectIdentificationModeCombo"),k.setValue(defaultIdentificationMode),identificationMode=defaultIdentificationMode,k.on("select",function(a,b,c){identificationMode=b.get("value");layerTree.fireEvent("leafschange")}));if(!1==maxExtent instanceof OpenLayers.Bounds){var l=OpenLayers.Projection.defaults[authid],k=void 0==l?!1:l.yx,l=wmsLoader.projectSettings.capability.nestedLayers[0].bbox;void 0==l[authid]&&exceptionLoading({status:200,responseText:"Map CRS "+authid+
" not published in QGIS Project properties OWS Server!"});l=l[authid].bbox;void 0!=l&&(maxExtent=OpenLayers.Bounds.fromArray(l,k),MapOptions.maxExtent=maxExtent)}selectedLayers=[];selectedQueryableLayers=[];allLayers=[];layerTree.root.firstChild.cascade(function(a){a.isLeaf()?(a.attributes.checked&&(selectedLayers.push(wmsLoader.layerTitleNameMapping[a.text]),wmsLoader.layerProperties[wmsLoader.layerTitleNameMapping[a.text]].queryable&&selectedQueryableLayers.push(wmsLoader.layerTitleNameMapping[a.text])),
allLayers.push(wmsLoader.layerTitleNameMapping[a.text]),buildLayerContextMenu(a)):buildGroupContextMenu(a);a.on("contextMenu",contextMenuHandler);a.on("checkchange",d)});mainStatusText.setText(mapLoadingString[lang]);format=imageFormatForLayers(selectedLayers);initialLoadDone&&(printCapabilities.layouts=[]);l=wmsLoader.projectSettings.capability.composerTemplates;if(0<l.length)for(printLayoutsDefined=!0,k=0;k<l.length;k++){var p=l[k],q=p.map.width/ptTomm,u=p.map.height/ptTomm;printCapabilities.layouts.push({name:p.name,
map:{width:q,height:u},size:{width:q,height:u},rotation:!0})}printUrl=printURI+"SERVICE=WMS&VERSION=1.3&REQUEST=GetPrint&FORMAT=pdf&EXCEPTIONS=application/vnd.ogc.se_inimage&TRANSPARENT=true";initialLoadDone?(printProvider.capabilities=printCapabilities,printProvider.url=printUrl):(printProvider=new QGIS.PrintProvider({method:"GET",capabilities:printCapabilities,url:printUrl}),printProvider.addListener("beforeprint",customBeforePrint),printProvider.addListener("afterprint",customAfterPrint));printExtent?
printExtent.printProvider=printProvider:printExtent=new GeoExt.plugins.PrintExtent({printProvider:printProvider});printExtent.initialized||(printExtent.initialized=!1);if(!initialLoadDone){var m=new OpenLayers.Style;m.addRules([new OpenLayers.Rule({symbolizer:Eqwc.settings.symbolizersHighLightLayer})]);m=new OpenLayers.StyleMap({"default":m})}k=Ext.getCmp("MapPanel");selectedLayers=a(selectedLayers);initialLoadDone?(geoExtMap.map.addLayers(f),thematicLayer.name=layerTree.root.firstChild.text,thematicLayer.url=
wmsURI,thematicLayer.mergeNewParams({LAYERS:selectedLayers.join(","),OPACITIES:b(selectedLayers),FORMAT:format})):(MapOptions.fallThrough=!0,geoExtMap=new GeoExt.MapPanel({frame:!1,border:!1,zoom:1.6,layers:f.concat(h.concat([thematicLayer=new OpenLayers.Layer.WMS(layerTree.root.firstChild.text,wmsURI,{layers:selectedLayers.join(","),opacities:b(selectedLayers),format:format,transparent:qgisLayerTransparency,dpi:screenDpi,VERSION:"1.3.0"},LayerOptions),highlightLayer=new OpenLayers.Layer.Vector("attribHighLight",
{isBaseLayer:!1,styleMap:m}),featureInfoHighlightLayer=new OpenLayers.Layer.Vector("Selection",{isBaseLayer:!1,styleMap:m,metadata:"editor"})])),map:MapOptions,id:"geoExtMapPanel",width:k.getInnerWidth(),height:k.getInnerHeight(),renderTo:k.body,plugins:[printExtent]}));initialLoadDone||(l=geoExtMap.map.getProjectionObject(),rightStatusText.setText(l.getCode()),urlParams.startExtent&&(m=urlParams.startExtent.split(","),m=new OpenLayers.Bounds(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3])),
geoExtMap.map.zoomToExtent(m,!1)),k.on("resize",function(a,b,c){geoExtMap.setSize(a.getInnerWidth(),a.getInnerHeight())}),urlParams.selection&&thematicLayer.mergeNewParams({SELECTION:urlParams.selection}),geoExtMap.map.events.register("zoomend",this,function(){var a=geoExtMap.map.getScale();Ext.getCmp("ScaleNumberField").setValue(Math.round(a));geoExtMap.map.zoomBoxActive&&Ext.getCmp("navZoomBoxButton").toggle(!1);customActionOnZoomEvent()}),geoExtMap.map.events.register("moveend",this,function(){customActionOnMoveEvent()}),
geoExtMap.map.events.register("zoomend",this,this.setGrayNameWhenOutsideScale),thematicLayer.events.register("loadstart",this,function(){mapIsLoading=!0;setTimeout("displayLoadMask()",2E3)}),thematicLayer.events.register("loadend",this,function(){mapIsLoading=!1;loadMask&&(loadMask.hide(),loadMask=null)}),m=Ext.getCmp("ScaleNumberField"),m.setValue(Math.round(geoExtMap.map.getScale())),m.on("change",function(a,b,c){Math.round(geoExtMap.map.getScale())!=b&&geoExtMap.map.zoomToScale(b,!0)}),m.on("specialkey",
function(a,b){if(b.getKey()==b.ENTER){var c=Math.round(geoExtMap.map.getScale()),d=a.getValue();c!=d&&geoExtMap.map.zoomToScale(d,!0)}36<b.getKey()&&41>b.getKey()&&b.stopPropagation()}),geoExtMap.map.addControl(new OpenLayers.Control.KeyboardDefaults),geoExtMap.map.addControl(new OpenLayers.Control.Navigation),geoExtMap.map.addControl(new OpenLayers.Control.Attribution),geoExtMap.map.addControl(new OpenLayers.Control.ScaleLine),geoExtMap.map.addControl(new OpenLayers.Control.Zoom),coordinateTextField=
Ext.getCmp("CoordinateTextField"),geoExtMap.map.events.register("mousemove",this,function(a){a=geoExtMap.map.events.getMousePosition(a);a=geoExtMap.map.getLonLatFromPixel(a);var b=0,c=geoExtMap.map.getScale();400>=c&&(b=1,100>=c&&(b=2));coordinateTextField.setRawValue(a.lon.toFixed(b)+","+a.lat.toFixed(b))}),coordinateTextField.on("specialkey",function(a,b){if(b.getKey()==b.ENTER){var c=a.getValue().split(","),c=new OpenLayers.LonLat(parseFloat(c[0]),parseFloat(c[1]));geoExtMap.map.setCenter(c)}36<
b.getKey()&&41>b.getKey()&&b.stopPropagation()}),coordinateTextField.on("change",function(a,b,c){a=b.split(",");a=new OpenLayers.LonLat(parseFloat(a[0]),parseFloat(a[1]));geoExtMap.map.setCenter(a)}),navHistoryCtrl=new OpenLayers.Control.NavigationHistory,geoExtMap.map.addControl(navHistoryCtrl));selectedQueryableLayers=a(selectedQueryableLayers);initialLoadDone&&(Eqwc.settings.enableHoverPopup&&geoExtMap.map.removeControl(WMSGetFInfoHover),geoExtMap.map.removeControl(WMSGetFInfo));WMSGetFInfo=new OpenLayers.Control.WMSGetFeatureInfo({layers:[thematicLayer],
infoFormat:"text/xml",queryVisible:!0,maxFeatures:Eqwc.settings.limitSearchMaxResults,vendorParams:{QUERY_LAYERS:selectedQueryableLayers.join(",")}});WMSGetFInfo.events.register("getfeatureinfo",this,showFeatureInfo);WMSGetFInfo.events.register("beforegetfeatureinfo",this,onBeforeGetFeatureInfoClick);WMSGetFInfo.events.register("nogetfeatureinfo",this,noFeatureInfoClick);geoExtMap.map.addControl(WMSGetFInfo);Eqwc.settings.enableHoverPopup&&(WMSGetFInfoHover=new OpenLayers.Control.WMSGetFeatureInfo({layers:[thematicLayer],
infoFormat:"text/xml",queryVisible:!0,hover:!0,vendorParams:{QUERY_LAYERS:selectedQueryableLayers.join(",")}}),WMSGetFInfoHover.events.register("getfeatureinfo",this,showFeatureInfoHover),geoExtMap.map.addControl(WMSGetFInfoHover));initialLoadDone||null==g||(OverviewMapOptions.maxExtent=maxExtent,geoExtMap.map.addControl(new OpenLayers.Control.OverviewMap({size:OverviewMapSize,minRatio:16,maxRatio:64,mapOptions:OverviewMapOptions,maximized:OverviewMapMaximized,layers:[g]})));if(!initialLoadDone){Ext.getCmp("IdentifyTool").toggle(!0);
identifyToolActive=!0;activateGetFeatureInfo(!0);g=Ext.getCmp("myTopToolbar");m=new Ext.Button({icon:iconDirectory+"mActionZoomFullExtent.png",id:"navZoomFullExtent",scale:"medium",map:geoExtMap.map,tooltip:zoomFullViewTooltipString[lang],tooltipType:"qtip",handler:mapToolbarHandler});g.insert(0,m);m=new GeoExt.Action({icon:iconDirectory+"mActionZoomBox.png",id:"navZoomBoxButton",scale:"medium",control:new OpenLayers.Control.ZoomBox({out:!1}),map:geoExtMap.map,tooltip:zoomRectangleTooltipString[lang],
tooltipType:"qtip",toggleGroup:"mapTools",enableToggle:!0,allowDepress:!0});g.insert(1,m);geoExtMap.map.zoomBoxActive=!1;Ext.getCmp("navZoomBoxButton").on("toggle",mapToolbarHandler);m=new GeoExt.Action({icon:iconDirectory+"mActionZoomLast.png",scale:"medium",control:navHistoryCtrl.previous,disabled:!0,tooltip:navigationHistoryBackwardTooltipString[lang],tooltipType:"qtip",id:"zoomLast",hidden:!projectData.zoom_back_forward});g.insert(2,m);m=new GeoExt.Action({icon:iconDirectory+"mActionZoomNext.png",
scale:"medium",control:navHistoryCtrl.next,disabled:!0,tooltip:navigationHistoryForwardTooltipString[lang],tooltipType:"qtip",id:"zoomNext",hidden:!projectData.zoom_back_forward});g.insert(3,m);if(projectData.geolocation){var r=new GeoExt.Action({icon:iconDirectory+"mActionLocate.png",id:"geoLocate",scale:"medium",control:new OpenLayers.Control.Geolocate({bind:!1,geolocationOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:7E3}}),map:geoExtMap.map,tooltip:showLocationTooltipString[lang],tooltipType:"qtip",
enableToggle:!1,allowDepress:!0,handler:mapToolbarHandler});g.insert(13,r);var v=function(a){var b=a.geometry.getCentroid(),c=a.geometry.getBounds(),d=Math.abs((c.right-c.left)/2),e=0,f="up";window.resizeInterval=window.setInterval(function(){16<e&&clearInterval(window.resizeInterval);var c=0.03*d/d;switch(e){case 4:case 12:f="down";break;case 8:f="up"}"up"!==f&&(c=-Math.abs(c));a.geometry.resize(1+c,b);featureInfoHighlightLayer.drawFeature(a);e++},50,b,d)};r.control.events.register("locationupdated",
r.control,function(a){featureInfoHighlightLayer.removeAllFeatures();var b=new OpenLayers.Feature.Vector(OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(a.point.x,a.point.y),a.position.coords.accuracy/2,40,0),{},locationAccuracyStyle);featureInfoHighlightLayer.addFeatures([new OpenLayers.Feature.Vector(a.point,{},locationMarkerStyle),b]);geoExtMap.map.zoomToExtent(featureInfoHighlightLayer.getDataExtent());v(b);r.control.bind=!0});r.control.events.register("locationfailed",
this,function(){Ext.Msg.alert("Error","Location detection failed");r.control.deactivate()})}if(useGeoCodeSearchBox||null!=searchBoxQueryURL)g.insert(g.items.length,new Ext.Toolbar.Fill),qgisSearchCombo=useGeoCodeSearchBox?new GeoExt.ux.GeocodingSearchCombo({map:geoExtMap.map,highlightLayerName:"attribHighLight",width:300,minChars:2,loadingText:geonamesLoadingString[lang],emptyText:geonamesEmptyString[lang],lang:lang,zoom:projectData.geoCode.zoom,countryString:projectData.geoCode.countryString,tpl:'<tpl for="."><div class="x-combo-list-item"><h3>{name2}</h3>{postalcode} {locality}, {region}</div></tpl>',
layers:projectData.geoCode.layers,sources:projectData.geoCode.sources,maxRows:10,displayField:"name2",key:projectData.geoCode.key}):new QGIS.SearchComboBox({map:geoExtMap.map,highlightLayerName:"attribHighLight",hasReverseAxisOrder:!1,width:300,searchtables:searchtables,url:searchBoxQueryURL,geomUrl:searchBoxGetGeomURL,srs:projectData.crs.split(":")[1]}),g.insert(g.items.length,qgisSearchCombo);g.doLayout();!0==mapThemeSwitcherActive&&(mapThemeSwitcher=new ThemeSwitcher(Ext.getCmp("MapPanel")),Ext.getCmp("mapThemeButton").show());
g=function(a){if("query"in urlParams){for(var b=null,c=0;c<a.length;c++)if(urlParams.query==a[c].query){b=a[c];break}Ext.Ajax.request({url:wmsURI,params:urlParams,method:"GET",success:function(a){var c=new QGIS.FeatureInfoParser;c.parseXML(a)&&0<c.featureIds().length&&(thematicLayer.mergeNewParams({SELECTION:b.selectionLayer+":"+c.featureIds().join(",")}),a=c.featuresBbox(),geoExtMap.map.zoomToExtent(new OpenLayers.Bounds(a.minx,a.miny,a.maxx,a.maxy)),a=1.1*geoExtMap.map.getScale(),500>a&&(a=500),
geoExtMap.map.zoomToScale(a))}})}};m=projectData.search;if(null!=m&&0<m.length){l=Ext.getCmp("SearchTabPanel");for(k=0;k<m.length;k++)p=new QGIS.SearchPanel(m[k]),p.gridLocation="default",p.gridTitle=searchResultString[lang],p.gridResults=Eqwc.settings.limitSearchMaxResults?Eqwc.settings.limitSearchMaxResults:10,p.on("featureselected",showRecordSelected),p.on("featureselectioncleared",clearFeatureSelected),p.on("beforesearchdataloaded",showSearchPanelResults),l.add(p);l.setActiveTab(0);g(m)}else g=
Ext.getCmp("SearchPanel"),g.removeAll(),g.hide();g=Ext.getCmp("LeftPanel");g.doLayout();g.addListener("resize",function(a,b,c,d,e){a.items.each(function(a,c,d){a.width=b});a.doLayout()});g=new OpenLayers.Style;g.addRules([new OpenLayers.Rule({symbolizer:sketchSymbolizersMeasureControls})]);g=new OpenLayers.StyleMap({"default":g});measureControls={line:new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{persist:!0,handlerOptions:{layerOptions:{styleMap:g}}}),polygon:new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,
{persist:!0,handlerOptions:{layerOptions:{styleMap:g}}})};for(var t in measureControls)g=measureControls[t],g.events.on({measure:handleMeasurements,measurepartial:handleMeasurements}),g.setImmediate(!0),g.geodesic=useGeodesicMeasurement,geoExtMap.map.addControl(g)}if(enableExtraLayers&&0<h.length)for(t=new Ext.tree.TreeNode({leaf:!1,expanded:!0,text:externalLayerTitleString[lang]}),layerTree.root.appendChild(t),t.on("contextMenu",Ext.emptyFn,null,{preventDefault:!0}),g=0;g<h.length;g++)m=new GeoExt.tree.LayerNode({layer:h[g],
leaf:!0,checked:h[g].visibility,uiProvider:Ext.tree.TriStateNodeUI}),t.appendChild(m),m.on("contextMenu",Ext.emptyFn,null,{preventDefault:!0});if(enableBGMaps&&0<f.length){h=new Ext.tree.TreeNode({leaf:!1,expanded:!0,text:backgroundLayerTitleString[lang]});layerTree.root.appendChild(h);h.on("contextMenu",Ext.emptyFn,null,{preventDefault:!0});if(null!=visibleBackgroundLayer)for(k=0;k<f.length;k++)if(f[k].name==visibleBackgroundLayer){c=k;break}for(k=0;k<f.length;k++)f[k].setVisibility(k==c),t=new GeoExt.tree.LayerNode({layer:f[k],
leaf:!0,checked:k==c,uiProvider:Ext.tree.TriStateNodeUI}),k==c&&(currentlyVisibleBaseLayer=f[k].name),h.appendChild(t),t.on("contextMenu",Ext.emptyFn,null,{preventDefault:!0}),t.on("checkchange",e)}initialLoadDone?(printLayoutsCombobox=Ext.getCmp("PrintLayoutsCombobox"),printLayoutsCombobox.store.removeAll(),printLayoutsCombobox.store.loadData(printCapabilities)):!0==printLayoutsDefined&&(printWindow=new Ext.Window({title:printSettingsToolbarTitleString[lang],height:"guest"==projectData.user?100:
160,width:390,layout:"fit",renderTo:"geoExtMapPanel",resizable:!1,closable:!1,x:8,y:8,items:[{xtype:"form",padding:"3",items:[{id:"printTitle",xtype:"textfield",maxLength:70,hideLabel:!0,emptyText:TR.emptyPrintTitleText,hidden:"guest"==projectData.user,anchor:"100%"},{id:"printDescription",xtype:"textarea",maxLength:150,boxMaxHeight:35,boxMinHeight:35,height:35,hideLabel:!0,emptyText:TR.emptyPrintDescriptionText,hidden:"guest"==projectData.user,anchor:"100%"}],bbar:{xtype:"toolbar",autoHeight:!0,
id:"myPrintToolbar",items:[{xtype:"combo",id:"PrintLayoutsCombobox",width:100,mode:"local",triggerAction:"all",readonly:!0,store:new Ext.data.JsonStore({data:printCapabilities,storeId:"printLayoutsStore",root:"layouts",fields:[{name:"name",type:"string"},"map","size","rotation"]}),valueField:"name",displayField:"name",listeners:{select:function(a,b,c){printProvider.setLayout(b)}}},{xtype:"tbspacer"},{xtype:"combo",id:"PrintScaleCombobox",width:95,mode:"local",triggerAction:"all",store:new Ext.data.JsonStore({data:printCapabilities,
storeId:"printScalesStore",root:"scales",fields:[{name:"name",type:"string"},{name:"value",type:"int"}]}),valueField:"value",displayField:"name",listeners:{select:function(a,b,c){printExtent.page.setScale(b)}}},{xtype:"tbspacer"},{xtype:"combo",id:"PrintDPICombobox",width:70,mode:"local",triggerAction:"all",store:new Ext.data.JsonStore({data:printCapabilities,storeId:"printDPIStore",root:"dpis",fields:[{name:"name",type:"string"},{name:"value",type:"int"}]}),valueField:"value",displayField:"name",
listeners:{select:function(a,b,c){printProvider.setDpi(b)}}},{xtype:"tbspacer"},{xtype:"label",text:printSettingsRotationTextlabelString[lang]},{xtype:"tbspacer"},{xtype:"spinnerfield",id:"PrintLayoutRotation",width:50,value:0,allowNegative:!0,autoStripChars:!0,allowDecimals:!1,minValue:-360,maxValue:360,enableKeyEvents:!0,listeners:{spin:function(){printExtent.page.setRotation(Ext.getCmp("PrintLayoutRotation").getValue(),!0)},keyup:function(a,b){printExtent.page.setRotation(Ext.getCmp("PrintLayoutRotation").getValue(),
!0);b.stopPropagation()},keydown:function(a,b){b.stopPropagation()},keypress:function(a,b){b.stopPropagation()}}},{xtype:"tbspacer"}]},buttons:[{tooltip:printButtonTooltipString[lang],text:printButtonTextString[lang],tooltipType:"qtip",iconCls:"",scale:"small",id:"StartPrinting",listeners:{click:function(){Ext.getCmp("PrintMap").toggle(!1);var a=wmsLoader.layerTitleNameMapping[Eqwc.settings.QgisUsersPrintName];printProvider.customParams={description:Ext.getCmp("printDescription").getValue(),title:Ext.getCmp("printTitle").getValue()};
void 0!==a&&(printProvider.customParams.filter=a+':"user_name" = \''+projectData.user+"'");printProvider.print(geoExtMap,[printExtent.page])}}},{tooltip:printCancelButtonTooltipString[lang],text:printCancelButtonTextString[lang],tooltipType:"qtip",iconCls:"",scale:"small",id:"CancelPrinting",listeners:{click:function(){Ext.getCmp("PrintMap").toggle(!1)}}}]}]}));!1==printLayoutsDefined?(c=Ext.getCmp("PrintMap"),c.disable(),c.setTooltip(printMapDisabledTooltipString[lang])):(printLayoutsCombobox=Ext.getCmp("PrintLayoutsCombobox"),
printLayoutsCombobox.setValue(printLayoutsCombobox.store.getAt(0).data.name),c=Ext.getCmp("PrintDPICombobox"),c.setValue("300"),c.fireEvent("select",c,c.findRecord(c.valueField,"300")),null!=fixedPrintResolution&&0<parseInt(fixedPrintResolution)&&(c.hide(),printWindow.setWidth(printWindow.width-71)),printWindow.show(),printWindow.hide());printExtent.hide();initialLoadDone&&(identifyToolWasActive&&(identifyToolWasActive=!1,Ext.getCmp("IdentifyTool").toggle(!0)),themeChangeActive=!1);layerTree.getSelectionModel().addListener("selectionChange",
function(a,b){themeChangeActive||layerTree.fireEvent("leafschange")});loadMask&&loadMask.hide();initialLoadDone=!0;setGrayNameWhenOutsideScale();customAfterMapInit()}
function showSearchPanelResults(a,b){if(b.length){var c=null,d=!0,e=!0,f="";switch(a.gridLocation){case "right":c=Ext.getCmp("RightPanel");f="SearchPanelResultsGrid";break;case "bottom":c=Ext.getCmp("BottomPanel");f="table_"+a.queryLayer;e=d=!1;break;case "popup":"undefined"==typeof Ext.getCmp("SearchResultsPopUp")&&(c=new Ext.Window({id:"SearchResultsPopUp",layout:"fit",width:"80%",height:300,modal:!1,closeAction:"hide"}));d=e=!1;c=Ext.getCmp("SearchResultsPopUp");break;default:d=!1,f="SearchPanelResultsGrid",
c=a}var h={};a.gridResults>a.gridResultsPageSize&&(h=new Ext.ux.PagingToolbar({pageSize:a.gridResultsPageSize,store:a.store,displayInfo:!1}));var g=!1;5>a.gridColumns.length&&(g=!0);if(!a.resultsGrid){var k=new Ext.ux.grid.GridFilters({encode:!1,local:!0,menuFilterText:TR.menuFilterText});a.resultsGrid=new Ext.grid.GridPanel({id:f,title:a.gridTitle,itemId:a.gridTitle,closable:a.tabClosable,collapsible:d,collapsed:!1,store:a.store,columns:a.gridColumns,plugins:[k],sm:new Ext.grid.RowSelectionModel({singleSelect:!0}),
autoHeight:e,viewConfig:{forceFit:g,templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}" tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},bbar:h,listeners:{render:function(a){a.store.on("load",function(c,d,e){1==b.length&&(a.getSelectionModel().selectFirstRow(),a.fireEvent("rowClick",a,0))})},filterupdate:function(){if(null!==a.resultsGrid){var b=[],c=wmsLoader.layerTitleNameMapping[a.queryLayer],
d=Ext.decode(Ext.encode(a.resultsGrid.filters.getFilterData()));Ext.each(d,function(a){if("string"==a.data.type)b.push('"'+a.field+"\" LIKE '%"+a.data.value+"%'");else if("numeric"==a.data.type){var c="";switch(a.data.comparison){case "gt":c=">";break;case "lt":c="<";break;case "eq":c="="}b.push('"'+a.field+'" '+c+" "+a.data.value)}});thematicLayer.mergeNewParams({FILTER:c+":"+b.join(" AND ")})}}}});d=[{iconCls:"x-clearfilter-icon",tooltip:TR.clearFilter,handler:function(){a.resultsGrid.filters.clearFilters()}},
{iconCls:"x-clear-icon",tooltip:TR.clearSelection,handler:clearTableSelection},{itemId:"loadmore",iconCls:"x-exclamation-icon",text:TR.loadMore,hidden:!0,tooltip:TR.loadMoreToolTip,scope:a,handler:loadMore}];!1==h.displayInfo&&a.resultsGrid.getBottomToolbar().add(d);c.add(a.resultsGrid)}a.resultsGrid.on("rowclick",a.onRowClick,a);a.resultsGrid.on("keypress",function(a){13==a.getKey()&&(a=this.getSelectionModel().last,this.fireEvent("rowclick",this,a))});c.doLayout();a.resultsGrid.show();a.resultsGrid.collapsible&&
a.resultsGrid.expand()}else c=this.el,"bottom"==this.gridLocation&&(c=Ext.getCmp("BottomPanel").el),c.unmask(),Ext.MessageBox.alert(searchPanelTitleString[lang],searchNoRecordsFoundString[lang]);return!0}function getVisibleLayers(a,b){for(;null!=b;){if(b.attributes.checked)a.push(wmsLoader.layerTitleNameMapping[b.text]);else if(null==b.attributes.checked)for(var c=0;c<b.childNodes.length;c++)a=getVisibleLayers(a,b.childNodes[c]);b=b.nextSibling}return a}
function getVisibleFlatLayers(a){visibleLayers=[];a.cascade(function(a){a.isLeaf()&&a.attributes.checked&&visibleLayers.push(wmsLoader.layerTitleNameMapping[a.text])})}function getVisibleBackgroundLayer(){var a=null;enableBGMaps&&layerTree.root.lastChild.cascade(function(b){b.isLeaf()&&b.attributes.checked&&(a=b.text)});return a}function uniqueLayersInLegend(a){var b=[],c=a.length,d,e,f;for(e=0;e<c;e++){d=void 0;for(f=0;f<b.length;f++)if(a[e]===b[f]){d=!0;break}d||b.push(a[e])}return b}
function mapToolbarHandler(a,b){removeMeasurePopup();customMapToolbarHandler(a,b);"IdentifyTool"==a.id&&(a.pressed?(identifyToolActive=!0,activateGetFeatureInfo(!0),mainStatusText.setText(modeObjectIdentificationString[lang])):(identifyToolActive=!1,activateGetFeatureInfo(!1),changeCursorInMap("default"),hoverPopup&&removeHoverPopup(),clickPopup&&removeClickPopup(),mainStatusText.setText(modeNavigationString[lang])));"measureDistance"==a.id&&(a.pressed?(measureControls.line.activate(),mainStatusText.setText(modeMeasureDistanceString[lang]),
changeCursorInMap("crosshair")):(measureControls.line.deactivate(),mainStatusText.setText(modeNavigationString[lang]),changeCursorInMap("default")));"measureArea"==a.id&&(a.pressed?(measureControls.polygon.activate(),mainStatusText.setText(modeMeasureAreaString[lang]),changeCursorInMap("crosshair")):(measureControls.polygon.deactivate(),mainStatusText.setText(modeNavigationString[lang]),changeCursorInMap("default")));"EmptySearchField"==a.id&&qgisSearchCombo.clearSearchResult();if("PrintMap"==a.id)if(a.pressed){printWindow.show();
!1==printExtent.initialized&&(printExtent.addPage(),printExtent.page.lastScale=Math.round(printExtent.page.scale.data.value),printExtent.page.lastRotation=0,Ext.getCmp("PrintScaleCombobox").setValue(printExtent.page.lastScale),printExtent.page.on("change",function(a,b){a.scale.data.value!=printExtent.page.lastScale&&(Ext.getCmp("PrintScaleCombobox").setValue(a.scale.data.value),printExtent.page.lastScale=a.scale.data.value);Math.round(a.rotation)!=printExtent.page.lastRotation&&(Ext.getCmp("PrintLayoutRotation").setValue(Math.round(a.rotation)),
printExtent.page.lastRotation=Math.round(a.rotation))}),printExtent.initialized=!0);var c=Ext.getCmp("PrintLayoutsCombobox"),d=c.store.findExact("name",c.getValue()),c=c.store.getAt(d);printProvider.layout.data.size.width==c.data.size.width&&printProvider.layout.data.size.height==c.data.size.height||printProvider.setLayout(c);printExtent.page.setRotation(0,!0);Ext.getCmp("PrintLayoutRotation").setValue(0);printExtent.page.fit(geoExtMap,{mode:"screen"});printExtent.show();mainStatusText.setText(modePrintingString[lang])}else printWindow.hide(),
printExtent.hide(),mainStatusText.setText(modeNavigationString[lang]);"navZoomBoxButton"==a.id&&(a.pressed?(geoExtMap.map.zoomBoxActive=!0,mainStatusText.setText(modeZoomRectangle[lang])):(geoExtMap.map.zoomBoxActive=!1,mainStatusText.setText(modeNavigationString[lang])));"navZoomFullExtent"==a.id&&geoExtMap.map.zoomToExtent(maxExtent,!1);"SendPermalink"==a.id&&(c=createPermalink(),permaLinkURLShortener?(d=location.protocol+"//"+location.href.split(/\/+/)[1],Ext.Ajax.request({url:d+permaLinkURLShortener,
success:receiveShortPermalinkFromDB,failure:function(a,b){alert("failed to get short URL from Python wsgi script.\n\nError Message:\n\n"+a.responseText)},method:"GET",params:{longPermalink:c}})):openPermaLink(c));"ShowFeedback"==a.id&&openFeedbackWin();"ShowHelp"==a.id&&(!0==help_active?(help_active=!1,helpWin.close()):(help_active=!0,"undefined"===typeof helpfile&&(helpfile="help_en.html",-1!=availableHelpLanguages.indexOf(lang)&&(helpfile="help_"+lang+".html")),helpWin=new Ext.Window({title:helpWindowTitleString[lang],
width:geoExtMap.getWidth(),height:0.7*geoExtMap.getHeight(),id:"autoload-win",autoScroll:!0,maximizable:!0,autoLoad:{url:helpfile},listeners:{show:function(){this.loadMask=new Ext.LoadMask(this.body,{msg:pleaseWaitString[lang]})},hide:function(){help_active=!1;helpWin.close()}}}),helpWin.show()));"geoLocate"==a.id&&(c=Ext.getCmp("geoLocate").baseAction.control,featureInfoHighlightLayer.removeAllFeatures(),a.pressed?(c.deactivate(),c.watch=!1):c.activate())}
function removeMeasurePopup(){var a=geoExtMap.map;measurePopup&&(a.removePopup(measurePopup),measurePopup.destroy(),measurePopup=null)}
function handleMeasurements(a){var b=a.geometry,c=a.units,d=a.measure,e="",e=1==a.order?e+(measureDistanceResultPrefixString[lang]+": "+d.toFixed(2)+c):e+(measureAreaResultPrefixString[lang]+": "+d.toFixed(2)+c+"<sup>2</sup>");a=geoExtMap.map;removeMeasurePopup();measurePopup=new OpenLayers.Popup.Anchored("measurePopup",b.getBounds().getCenterLonLat(),null,e,null,!1,null);measurePopup.autoSize=!0;measurePopup.keepInMap=!0;measurePopup.panMapIfOutOfView=!0;a.addPopup(measurePopup);measurePopup.setOpacity(0.8)}
function displayLoadMask(){mapIsLoading&&(loadMask=new Ext.LoadMask(Ext.getCmp("MapPanel").body,{msg:mapLoadingString[lang]}),loadMask.show())}function changeCursorInMap(a){Ext.query(".olMapViewport",document.getElementById("geoExtMapPanel"))[0].style.cursor=a}function scrollToHelpItem(a){Ext.get(a).dom.scrollIntoView()}
function createPermalink(){var a=[],b,c={},a=getVisibleLayers(a,layerTree.root.firstChild),a=uniqueLayersInLegend(a),d=getVisibleBackgroundLayer();b=geoExtMap.map.getExtent().toArray();var e=b[0]+","+b[1]+","+b[2]+","+b[3];norewrite?(b=urlArray[0]+"?map=",b=b+"/"+wmsMapName.replace("/",""),b.match(/\.qgs$/)||(b+=".qgs"),b+="&"):(b=location.href.split(/\/+/)[1],b=location.protocol+"//"+b,b=projectData.gis_projects?b+projectData.gis_projects.path:b+"/",b+=wmsMapName+"?");c.startExtent=e;c.visibleBackgroundLayer=
d;c.visibleLayers=a.toString();a=null;for(layer in wmsLoader.layerProperties)wmsLoader.layerProperties.hasOwnProperty(layer)&&(d=wmsLoader.layerProperties[layer].opacity,255!=d&&(null==a&&(a={}),a[layer]=d));null!=a&&(c.opacities=Ext.util.JSON.encode(a));showLayerOrderTab&&(c.initialLayerOrder=layerOrderPanel.orderedLayers().toString());c.lang=lang;"undefined"!=typeof thematicLayer.params.SELECTION&&(c.selection=thematicLayer.params.SELECTION);return b=permaLinkURLShortener?encodeURIComponent(b+decodeURIComponent(Ext.urlEncode(c))):
b+Ext.urlEncode(c)}function addAbstractToLayerGroups(){var a=layerTree.getNodeById("wmsNode");a.firstChild.cascade(function(b){b.isLeaf()||(wmsLoader.layerProperties[wmsLoader.layerTitleNameMapping[b.text]]["abstract"]=b==a.firstChild?wmsLoader.projectSettings.service["abstract"]:layerGroupString[lang]+' "'+b.text+'"')})}
function applyPermalinkParams(){var a=void 0;urlParams.opacities&&(a=Ext.util.JSON.decode(urlParams.opacities));if(a)for(layer in a)a.hasOwnProperty(layer)&&(wmsLoader.layerProperties[layer].opacity=a[layer])}function activateGetFeatureInfo(a){a?(WMSGetFInfo.activate(),Eqwc.settings.enableHoverPopup&&WMSGetFInfoHover.activate()):(WMSGetFInfo.deactivate(),Eqwc.settings.enableHoverPopup&&WMSGetFInfoHover.deactivate())}
function openPermaLink(a){"undefined"!=typeof PermaLinkWin&&PermaLinkWin.close();PermaLinkWin=(new Ext.Window({title:sendPermalinkLinkFromString[lang],width:200,layout:"fit",items:[{xtype:"textarea",grow:!0,value:a,anchor:"100%",selectOnFocus:!0}]})).show()}
function openFeedbackWin(){var a=new Ext.form.FormPanel({baseCls:"x-plain",labelWidth:55,url:"save-form.php",layout:{type:"vbox",align:"stretch"},defaults:{xtype:"textfield"},items:[{xtype:"textarea",fieldLabel:"Message text",hideLabel:!0,name:"msg",flex:1},{xtype:"label",text:TR.feedbackDescription,hideLabel:!0}]});"undefined"!=typeof feedbackWin?feedbackWin.show():feedbackWin=(new Ext.Window({title:TR.feedbackTitle,width:450,height:300,minWidth:300,minHeight:200,layout:"fit",closeAction:"hide",
plain:!0,buttonAlign:"center",items:a,buttons:[{itemId:"send",text:TR.send,handler:feedbackHandler},{itemId:"cancel",text:TR.cancel,handler:feedbackHandler}]})).show()}
function feedbackHandler(a){a=a.itemId;"cancel"==a&&feedbackWin.hide();if("send"==a){a=[];var b=feedbackWin.items.get(0).getForm(),c=b.findField("msg").getValue(),d=createPermalink();a.push("USER: "+projectData.user);a.push("MESSAGE: "+c);a.push("LINK: "+d);feedbackWin.hide();b.reset();sendMail(projectData.userFeedbackMailto,"EQWC "+projectData.project+" "+TR.feedback,a.join("\r\n"),!1)}}
function sendMail(a,b,c,d){var e={};e.mailto=a;e.subject=b;e.body=c;""<Eqwc.settings.mailServiceUrl&&Ext.Ajax.request({url:Eqwc.settings.mailServiceUrl,params:e,method:"POST",success:function(a){},failure:function(a){d||Ext.Msg.alert("Error sending feedback",a.statusText)}})}function receiveShortPermalinkFromDB(a,b){a=eval("("+a.responseText+")");openPermaLink(a.shortUrl)}
function imageFormatForLayers(a){var b=origFormat;if(0<layerImageFormats.length&&origFormat.match(/8bit/))for(var c=0;c<layerImageFormats.length;c++){for(var d=layerImageFormats[c],e=0;e<d.layers.length;e++)if(-1!=a.indexOf(d.layers[e])){b=d.format;break}if(b!=origFormat)break}return b}
function setGrayNameWhenOutsideScale(){if(grayLayerNameWhenOutsideScale){var a=[];layerTree.root.firstChild.cascade(function(b){b.isLeaf()&&a.push([b.text,b.id])});for(var b=0;b<wmsLoader.projectSettings.capability.layers.length;b++)if(MaxScale=Math.round(wmsLoader.projectSettings.capability.layers[b].maxScale),1>MaxScale&&(MaxScale=1),MinScale=Math.round(wmsLoader.projectSettings.capability.layers[b].minScale),1>MinScale&&(MinScale=15E7),wmsLoader.projectSettings.capability.layers[b].maxScale>geoExtMap.map.getScale()||
wmsLoader.projectSettings.capability.layers[b].minScale<geoExtMap.map.getScale())for(var c=0;c<a.length;c++)a[c][0]==wmsLoader.projectSettings.capability.layers[b].title&&(layerTree.root.findChild("id",a[c][1],!0).setCls("outsidescale"),strTOCTooltip=tooltipLayerTreeLayerOutsideScale[lang]+" 1:"+MaxScale+" - 1:"+MinScale,layerTree.root.findChild("id",a[c][1],!0).setTooltip(strTOCTooltip),layerTree.root.findChild("id",a[c][1],!0).isOutsideScale=!0,layerTree.root.findChild("id",a[c][1],!0).MinScale=
MinScale,layerTree.root.findChild("id",a[c][1],!0).MaxScale=MaxScale);else for(c=0;c<a.length;c++)if(a[c][0]==wmsLoader.projectSettings.capability.layers[b].title){layerTree.root.findChild("id",a[c][1],!0).setTooltip("");var d=layerTree.root.findChild("id",a[c][1],!0);d.ui.removeClass("outsidescale");layerTree.root.findChild("id",a[c][1],!0).isOutsideScale=!1;layerTree.root.findChild("id",a[c][1],!0).MinScale=MinScale;layerTree.root.findChild("id",a[c][1],!0).MinScale=MaxScale}var e=[],f=[],h=[],
g=[];layerTree.root.firstChild.cascade(function(a){a.isLeaf()||(layerTree.root.findChild("id",a.id,!0).cascade(function(a){a.isLeaf()&&(f.push(a.isOutsideScale),h.push(a.MaxScale),g.push(a.MinScale))}),e.push([a.id,a.text,f,h,g]));f=[];h=[];g=[]});for(b=0;b<e.length;b++){d=!0;MinScale=0;MaxScale=15E7;for(c=0;c<e[b][2].length;c++)MinScale<e[b][4][c]&&(MinScale=e[b][4][c]),MaxScale>e[b][3][c]&&(MaxScale=e[b][3][c]),e[b][2][c]||(d=!1);d?(layerTree.root.findChild("id",e[b][0],!0).setCls("outsidescale"),
strTOCTooltip=tooltipLayerTreeLayerOutsideScale[lang]+" 1:"+MaxScale+" - 1:"+MinScale,layerTree.root.findChild("id",e[b][0],!0).setTooltip(strTOCTooltip)):(d=layerTree.root.findChild("id",e[b][0],!0),d.ui.removeClass("outsidescale"),layerTree.root.findChild("id",e[b][0],!0).setTooltip(""))}}}function exceptionLoading(a){loadMask.hide();Ext.Msg.show({title:"Error code: "+a.status,msg:a.responseText,buttons:Ext.MessageBox.OK,fn:logout})}
function logout(){window.location.href="./admin/login.php?action=logout"};
